@page "/bkg_user_admin"
@rendermode InteractiveServer
<PageTitle>RV Park Administration</PageTitle>

@using RVParking.Data
@using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
@using Microsoft.EntityFrameworkCore;

@inject ApplicationDbContext ApplicationDbContext

<AuthorizeView Roles="Admin" Context="authContext">
    <NotAuthorized>
        <div class="tab-content" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h4>- You are NOT AUTHORIZED -</h4>
            </div>
        </div>
    </NotAuthorized>
    <Authorized>
        <!--  -->
        <div class="tab-content" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h4>Booking Users (May not have or need an App login)</h4>
            </div>
            <div>
                <button class="btn btn-primary" @onclick="OpenAddModal">Add New Booking User</button>
            </div>
        </div>

        @if (users == null)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            @if (isEditing)
            {
                <h5 style="margin-left: 2%">Editing Booking User</h5>
                <EditForm Model="currentUser" OnValidSubmit="SaveUser">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="form-group" style="display:flex;flex-direction:row; margin-left: 2%">
                        <div>
                            <label>User Name</label>
                            <InputText @bind-Value="currentUser.UserName" title="Normally your email address" class="form-control" />
                        </div>
                        <div>
                            <label>Email</label>
                            <InputText @bind-Value="currentUser.UserEmail" class="form-control" />
                        </div>
                        <div>
                            <label>Status</label>
                            <InputText @bind-Value="currentUser.UserStatus" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group" style="display:flex;flex-direction:row; margin-left: 2%">
                        <div>
                            <label>First Name</label>
                            <InputText @bind-Value="currentUser.UserFirstName" class="form-control" />
                        </div>
                        <div>
                            <label>Last Name</label>
                            <InputText @bind-Value="currentUser.UserLastName" class="form-control" />
                        </div>
                        <div>
                            <label>Phone Number</label>
                            <InputText @bind-Value="currentUser.UserPhone" class="form-control" />
                        </div>
                        <div>
                            <label>NZMCA #</label>
                            <InputText @bind-Value="currentUser.UserNZMCA" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group" style="display:flex;flex-direction:row; margin-left: 2%">
                        <div style="max-width: 80%; width: 400px">
                            <label>Address</label>
                            <InputTextArea @bind-Value="currentUser.UserAddress" class="form-control" />
                        </div>
                        <div style="max-width: 50%;">
                            <label>City</label>
                            <InputText @bind-Value="currentUser.UserCity" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group" style="display:flex;flex-direction:row; margin-left: 2%">
                        <div style="max-width: 15%; ">
                            <label>State</label>
                            <InputText @bind-Value="currentUser.UserState" class="form-control" />
                        </div>
                        <div style="max-width: 15%; ">
                            <label>Zip</label>
                            <InputText @bind-Value="currentUser.UserZip" class="form-control" />
                        </div>
                        <div style="max-width: 50%; ">
                            <label>Country</label>
                            <InputText @bind-Value="currentUser.UserCountry" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group" style="display:flex;flex-direction:row; margin-left: 2%">
                        <div style="max-width: 80%; width: 660px">
                            <label>Comments</label>
                            <InputTextArea @bind-Value="currentUser.UserComments" class="form-control" />
                        </div>
                    </div>


                    <div style="margin-left: 2%;">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    </div>
                </EditForm>
            }

            <!-- Filter Section -->
            <div class="row" style="margin: 20px 0;">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               placeholder="Filter by Name, Email, or Comments..." 
                               @bind="filterText" 
                               @bind:event="oninput"
                               @onkeyup="FilterUsers" />
                        @if (!string.IsNullOrEmpty(filterText))
                        {
                            <button class="btn btn-outline-secondary" type="button" @onclick="ClearFilter">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        }
                    </div>
                    @* <small class="text-muted">Showing @filteredUsers.Count of @users.Count users</small> *@
                </div>
                <div class="col-md-6 text-end">
                    <label class="me-2">Rows per page:</label>
                    <select class="form-select d-inline-block" style="width: auto;" @bind="pageSize" @bind:after="UpdatePagination">
                        <option value="05">05</option>
                        <option value="10">10</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #929292;">User Name</th>
                            <th style="border: 1px solid #929292;">First Name</th>
                            <th style="border: 1px solid #929292;">Last Name</th>
                            <th style="border: 1px solid #929292;">Actions</th>
                            <th style="border: 1px solid #929292;">Email</th>
                            <th style="border: 1px solid #929292;">Phone</th>
                            <th style="border: 1px solid #929292;">NZMCA</th>
                            <th style="border: 1px solid #929292;">Address</th>
                            <th style="border: 1px solid #929292;">City</th>
                            <th style="border: 1px solid #929292;">State</th>
                            <th style="border: 1px solid #929292;">Zip</th>
                            <th style="border: 1px solid #929292;">Country</th>
                            <th style="border: 1px solid #929292;">Status</th>
                            <th style="border: 1px solid #929292;">Comments</th>
                            <th style="border: 1px solid #929292;">Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in pagedUsers)
                        {
                            <tr>
                                <td style="border: 1px solid #929292;">@user.UserName</td>
                                <td style="border: 1px solid #929292;">@user.UserFirstName</td>
                                <td style="border: 1px solid #929292;">@user.UserLastName</td>
                                <td style="border: 1px solid #929292;">
                                    <div class="tab-content" style="display:flex;flex-direction:row;">
                                        <button class="bi form-control" style="width: 40px; height: 32px;"
                                                @onclick="() => EditUser(user)">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <button class="bi form-control" style="width: 40px; height: 32px;"
                                                @onclick="() => DeleteUser(user.UserId)">
                                            <i class="bi bi-trash3" style="block-size:max-content;"></i>
                                        </button>
                                    </div>
                                </td>
                                <td style="border: 1px solid #929292;">@user.UserEmail</td>
                                <td style="border: 1px solid #929292;">@user.UserPhone</td>
                                <td style="border: 1px solid #929292;">@user.UserNZMCA</td>
                                <td style="border: 1px solid #929292;">@user.UserAddress</td>
                                <td style="border: 1px solid #929292;">@user.UserCity</td>
                                <td style="border: 1px solid #929292;">@user.UserState</td>
                                <td style="border: 1px solid #929292;">@user.UserZip</td>
                                <td style="border: 1px solid #929292;">@user.UserCountry</td>
                                <td style="border: 1px solid #929292;">@user.UserStatus</td>
                                <td style="border: 1px solid #929292;">@user.UserComments</td>
                                <td style="border: 1px solid #929292;">@user.CreatedDte.ToString("dd/MM/yyyy")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            @if (totalPages > 1)
            {
                <nav aria-label="User pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(1)" disabled="@(currentPage == 1)">First</button>
                        </li>
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">Previous</button>
                        </li>
                        
                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                        {
                            var pageNum = i;
                            <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                <button class="page-link" @onclick="() => ChangePage(pageNum)">@pageNum</button>
                            </li>
                        }
                        
                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(currentPage + 1)" disabled="@(currentPage == totalPages)">Next</button>
                        </li>
                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(totalPages)" disabled="@(currentPage == totalPages)">Last</button>
                        </li>
                    </ul>
                </nav>
            }

        }

        <!-- Modal Dialog for Error Messages -->
        @if (showErrorModal)
        {
            <div class="modal show" tabindex="-1" style="display: block;">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Issue when trying to SAVE this Booking User</h5>
                            <button type="button" class="btn-close" @onclick="CloseErrorModal"></button>
                        </div>
                        <div class="modal-body">
                            <p>@errorMessage</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseErrorModal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        }
        @if (showYesErrorModal)
        {
            <div class="modal show" tabindex="-1" style="display: block;">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Data Adjustments may be needed before SAVING?</h5>
                            <button type="button" class="btn-close" @onclick="CloseYesErrorModal"></button>
                        </div>
                        <div class="modal-body">
                            <p>@errorMessage</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseYesErrorModalYes">YES</button>
                            <button type="button" class="btn btn-secondary" @onclick="CloseYesErrorModal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        }

    </Authorized>
</AuthorizeView>

@code {
    private List<Bkg_User> users;
    private List<Bkg_User> filteredUsers = new();
    private List<Bkg_User> pagedUsers = new();
    private Bkg_User currentUser = new Bkg_User();
    private bool isEditing = false;
    private bool showErrorModal = false;
    private bool showYesErrorModal = false;
    private string errorMessage;
    
    // Filter and pagination properties
    private string filterText = string.Empty;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages => (int)Math.Ceiling((double)filteredUsers.Count / pageSize);

    protected override async Task OnInitializedAsync()
    {
        users = await ApplicationDbContext.bkg_Users.ToListAsync();
        filteredUsers = users;
        UpdatePagedUsers();
    }

    private void FilterUsers()
    {
        if (string.IsNullOrWhiteSpace(filterText))
        {
            filteredUsers = users;
        }
        else
        {
            var searchTerm = filterText.ToLower();
            filteredUsers = users.Where(u =>
                (!string.IsNullOrEmpty(u.UserName) && u.UserName.ToLower().Contains(searchTerm)) ||
                (!string.IsNullOrEmpty(u.UserFirstName) && u.UserFirstName.ToLower().Contains(searchTerm)) ||
                (!string.IsNullOrEmpty(u.UserLastName) && u.UserLastName.ToLower().Contains(searchTerm)) ||
                (!string.IsNullOrEmpty(u.UserEmail) && u.UserEmail.ToLower().Contains(searchTerm)) ||
                (!string.IsNullOrEmpty(u.UserComments) && u.UserComments.ToLower().Contains(searchTerm))
            ).ToList();
        }
        
        currentPage = 1; // Reset to first page when filtering
        UpdatePagedUsers();
    }

    private void ClearFilter()
    {
        filterText = string.Empty;
        FilterUsers();
    }

    private void UpdatePagination()
    {
        currentPage = 1;
        UpdatePagedUsers();
    }

    private void ChangePage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            UpdatePagedUsers();
        }
    }

    private void UpdatePagedUsers()
    {
        pagedUsers = filteredUsers
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void EditUser(Bkg_User user)
    {
        currentUser = user;
        isEditing = true;
    }

    private async Task DeleteUser(int userId)
    {
        var user = await ApplicationDbContext.bkg_Users.FindAsync(userId);
        if (user != null)
        {
            ApplicationDbContext.bkg_Users.Remove(user);
            await ApplicationDbContext.SaveChangesAsync();
            users.Remove(user);
            FilterUsers(); // Refresh the filtered and paged lists
        }
    }

    private async Task SaveUser()
    {

        if (currentUser.UserName.Length > 0 && currentUser.UserId == 0) // Have a new user so need to check is not in already as UserId is treated as the Busines Logiacl PK for this entity
        {
            var user = await ApplicationDbContext.bkg_Users.FirstOrDefaultAsync(u => u.UserName == currentUser.UserName);
            if (user != null)
            {
                // need to dispay an error and exit
                errorMessage = "A user with this username already exists.";
                showErrorModal = true;
                // need to dispay a message with a yes option JUST TO TEST
                // errorMessage = "An Application User with this username already exists. Do you wish to merge the information?";
                // showYesErrorModal = true;

                return;
            }

        }
        try
        {
            if (currentUser.UserId == 0)
            {
                ApplicationDbContext.bkg_Users.Add(currentUser);
            }
            else
            {
                ApplicationDbContext.bkg_Users.Update(currentUser);
            }
            await ApplicationDbContext.SaveChangesAsync();
            users = await ApplicationDbContext.bkg_Users.ToListAsync();
            FilterUsers(); // Refresh the filtered and paged lists
            isEditing = false;
            currentUser = new Bkg_User();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private void CancelEdit()
    {
        isEditing = false;
        currentUser = new Bkg_User();
    }

    private void OpenAddModal()
    {
        currentUser = new Bkg_User();
        isEditing = true;
    }

    private void CloseErrorModal()
    {
        showErrorModal = false;
    }

    private void CloseYesErrorModal()
    {
        // Need to do whatever the question asked in the message
        showYesErrorModal = false;
    }

    private void CloseYesErrorModalYes()
    {
        // Need to do whatever the question asked in the message
        showYesErrorModal = false;
    }
}

@page "/Account/RegisterCP"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using RVParking.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject ILogger<RegisterFull> Logger
@inject NavigationManager NavigationManager
@inject ApplicationDbContext ApplicationDbContext

<PageTitle>Register Full</PageTitle>

<h1>Register (Full Details)</h1>



@if (!codesSent)
{
    <EditForm Model="@userInfo" OnValidSubmit="@SendCodes" FormName="FrmSendCodes">
        <InputText @bind-Value="userInfo.Email" placeholder="Email" />
        <InputText @bind-Value="userInfo.PhoneNumber" placeholder="Phone Number" />
        <button type="submit">Send Verification Codes</button>
    </EditForm>
}
@if (codesSent)
{
    <EditForm Model="@verificationInfo" OnValidSubmit="@VerifyCodes" FormName="FrmVerifyCodes">
        <InputText @bind-Value="verificationInfo.EmailCode" placeholder="Enter Email Code" />
        <InputText @bind-Value="verificationInfo.SmsCode" placeholder="Enter SMS Code" />
        <button type="submit">Verify</button>
    </EditForm>

    @if (verificationResult != null)
    {
        <p>@verificationResult</p>
    }
}

@code {
    private UserInfo userInfo = new();
    private VerificationInfo verificationInfo = new();
    private bool codesSent = false;
    private string sentEmailCode;
    private string sentSmsCode;
    private string verificationResult;

    private async Task SendCodes()
    {
        sentEmailCode = GenerateCode();
        sentSmsCode = GenerateCode();

        // await EmailService.SendEmailAsync(userInfo.Email, $"Your code: {sentEmailCode}");
        // await SmsService.SendSmsAsync(userInfo.PhoneNumber, $"Your code: {sentSmsCode}");

        codesSent = true;
    }

    private async Task VerifyCodes()
    {
        bool emailMatch = verificationInfo.EmailCode == sentEmailCode;
        bool smsMatch = verificationInfo.SmsCode == sentSmsCode;

        verificationResult = emailMatch && smsMatch ? "✅ Verified!" : "❌ Verification failed.";
    }

    private string GenerateCode() => new Random().Next(100000, 999999).ToString();
    public class UserInfo
    {
        public string Email { get; set; }
        public string PhoneNumber { get; set; }
    }

    public class VerificationInfo
    {
        public string EmailCode { get; set; }
        public string SmsCode { get; set; }
    }
}

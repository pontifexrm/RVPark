@page "/allbookings"
@rendermode InteractiveServer
<PageTitle>RV Park Administration</PageTitle>


@using RVParking.Data
@using RVParking.Components.Account

@using Microsoft.AspNetCore.Identity.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using TNZAPI.NET;
@using TNZAPI.NET.Core;
@using TNZAPI.NET.Api.Addressbook.Contact.Dto;

@* Is Being Used *@

@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor

@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject ApplicationDbContext ApplicationDbContext

@inject IConfiguration configuration
<!-- Page header with title and button to add a new Booking -->
<div class="tab-content" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h4>Current Open Bookings - Add, Edit, and Delete All Bookings</h4>
    </div>
    <div>
        <button class="btn btn-primary" @onclick="OpenAddModal">Add New Booking</button>
    </div>
</div>

<!-- Search Bar -->
<div class="search-bar" style="display:flex; flex-wrap: wrap; gap: 4px;">
    <input type="text" style="flex: 1 1 200px;" placeholder="Search by Client or Bkg Ref:" @bind="searchUsername" />
    <input type="date" style="flex: 1 1 200px;" @bind="searchFromDate" />
    <input type="date" style="flex: 1 1 200px;" @bind="searchToDate" />
    <select style="flex: 1 1 200px;" @bind="searchPropertyId">
        <option value="">Select Property</option>
        @foreach (var property in properties)
        {
            <option value="@property.PropertyId">@property.Name</option>
        }
    </select>
    <input type="text" style="flex: 1 1 200px; max-width: 300px" placeholder="Search by Status" @bind="searchStatus" />
    <button class="bi form-control" style="flex: 0 0 40px; height: 32px; margin-left: 4px;"
            @onclick="ClearSearch">
        <i class="bi bi-x-lg"></i>
    </button>
    <button class="bi form-control" style="flex: 0 0 40px; height: 32px; margin-left: 4px;"
            @onclick="SearchBookings">
        <i class="bi bi-search"></i>
    </button>
</div>
<br />

<!-- Load Table of all open bookings Bookings -->
@if (bookings == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th style="border: 1px solid #929292;">Fm - To Dates</th>
                    <th style="border: 1px solid #929292;">First Name</th>
                    <th style="border: 1px solid #929292;">Last Name</th>
                    <th style="border: 1px solid #929292;">Phone</th>
                    <th style="border: 1px solid #929292;">Property Name</th>
                    <th style="border: 1px solid #929292;">Bkg Ref</th>
                    <th style="border: 1px solid #929292;">Paid</th>
                    <th style="border: 1px solid #929292;">Status</th>
                    <th style="border: 1px solid #929292;">Comments</th>
                    <th style="border: 1px solid #929292;">Bkg Username</th>
                    <th style="border: 1px solid #929292;"><small>Edit Delete Confirm</small></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var booking in bookings)
                {
                    <tr>
                        <td style="border: 1px solid #929292;">@booking.DateArrive.ToShortDateString() to @booking.DateDepart.ToShortDateString()</td>
                        <td style="border: 1px solid #929292;">@booking.Bkg_User.UserFirstName</td>
                        <td style="border: 1px solid #929292;">@booking.Bkg_User.UserLastName</td>
                        <td style="border: 1px solid #929292;">@booking.Bkg_User.UserPhone</td>
                        <td style="border: 1px solid #929292;">@booking.Bkg_Property.Name</td>
                        <td style="border: 1px solid #929292;">@booking.BookingId</td>
                        <td style="border: 1px solid #929292;">@(booking.Paid ? "Y" : "N")</td>
                        <td style="border: 1px solid #929292;">@booking.BookingStatus</td>
                        <td style="border: 1px solid #929292;">@booking.BookingComments</td>
                        <td style="border: 1px solid #929292;">@booking.Bkg_User.UserName</td>
                        <td style="border: 1px solid #929292;">
                            <div class="tab-content" style="display:flex;flex-direction:row;">
                                <button class="bi form-control" style="width: 40px; height: 32px;" @onclick="() => EditBooking(booking)">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="bi form-control" style="width: 40px; height: 32px;" @onclick="() => DeleteBooking(booking.BookingId)">
                                    <i class="bi bi-trash3" style="block-size:max-content;"></i>
                                </button>
                                <button class="bi form-control" style="width: 70px; height: 32px;" @onclick="() => SendConfirmationModal(booking.BookingId)">
                                    <i class="bi bi-chat-text" style="block-size:max-content;"></i>
                                    <i class="bi bi-envelope-arrow-up" style="block-size:max-content;"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- Modal Dialog for Editing/Adding Bookings -->
@if (showModal)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@modalTitle</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>

                </div>
                @if (!string.IsNullOrEmpty(modalMessage))
                {
                    <div class="modal-header" style="color:midnightblue"><small>@modalMessage</small></div>
                }

                @* <div class="modal-header">@modalMessage</div> *@
                <div class="modal-body">
                    <EditForm Model="currentBooking" OnValidSubmit="SaveBooking">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="form-group">
                            <label>Bkg User</label>
                            <InputSelect @bind-Value="currentBooking.UserId" class="form-control">
                                @foreach (var user in users)
                                {
                                    <option value="@user.UserId">@user.UserName</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group">
                            <label>Property</label>
                            <InputSelect @bind-Value="currentBooking.PropertyId" class="form-control">
                                @foreach (var property in properties)
                                {
                                    <option value="@property.PropertyId">@property.Name</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group" style="display:flex;flex-direction:row;">
                            <div class="form-group" style=" text-align:center; width: 160px; margin-left: 1%">
                                <label for="fmdate">Arriving</label>
                                <SfDatePicker TValue="DateTime?" Value="@Fmdate" Placeholder='Choose a Date' ID="fmdate">
                                    <DatePickerEvents TValue="DateTime?" ValueChange="DteAriveChnge"></DatePickerEvents>
                                </SfDatePicker>

                                @* <SfDatePicker TValue="DateTime?" Value="@currentBooking.DateArrive" Placeholder='Choose a Date' ID="fmdate"> </SfDatePicker> *@
                            </div>

                            <div class="form-group" style=" text-align:center; width: 160px; margin-left: 1%">
                                <label for="tmdate">Departing</label>
                                <SfDatePicker TValue="DateTime?" Value="@Todate" Placeholder='Choose a Date' ID="todate">
                                    <DatePickerEvents TValue="DateTime?" ValueChange="DteDepartChnge"></DatePickerEvents>
                                </SfDatePicker>
                                @* <SfDatePicker TValue="DateTime?" Value="@currentBooking.DateDepart" Placeholder='Choose a Date' ID="todate"></SfDatePicker> *@
                            </div>
                        </div>





                        @*                         <div class="form-group">
                            <label>Arrival Date</label>
                            <InputDate @bind-Value="currentBooking.DateArrive" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Departure Date</label>
                            <InputDate @bind-Value="currentBooking.DateDepart" class="form-control" />
                        </div> *@
                        <div class="form-group">
                            <label>Has Paid </label>
                            <InputCheckbox @bind-Value="currentBooking.Paid" />
                        </div>
                        <div class="form-group">
                            <label>Comments</label>
                            <InputTextArea @bind-Value="currentBooking.BookingComments" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Status <small>(Requested,Confirmed,Paid,Arrived,Closed,Cancelled)</small></label>
                            <InputText @bind-Value="currentBooking.BookingStatus" class="form-control" />
                        </div>
                        @if (allDatesAvailable)
                        {
                            <button type="submit" class="btn btn-primary">Save</button>
                        }

                        @* <button type="submit" class="btn btn-primary">Save</button> *@
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal Dialog for Sending Email Confirmation -->
@if (sendConfirmMsg)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog" stype=" width: 900px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm booking by Txt or Email</h5>
                    @* <small>Normally to the Bkg User but can email to the logged in user or txt or email to another that you enter.</small> *@
                    <button type="button" class="btn-close" @onclick="CloseConfirmModal"></button>
                </div>
                <div class="modal-header" style="color:midnightblue"><small>Sent normally to the Bkg User but you can email to yourself (enter 'Me') or email/txt another by entering their email or phone number.</small></div>
                <div class="modal-header">
                    <div class="form-group" style="display: block;">
                        <label>Email Confirm to Me or Other</label>
                        <input type="text" style="flex: 1 1 200px; max-width: 200px" placeholder="Me or Other Txt/Email" @bind="adhocConfirm" />
                        <button type="button" class="btn btn-secondary" @onclick="SendAdhocConfirmation">Adhoc Confirm</button>
                    </div>
                    <div class="form-group" style="display: block;">
                        <label>Email Confirm to Client</label>
                        <button type="button" class="btn btn-secondary" @onclick="SendEmailConfirmation">Email Confirm</button>
                    </div>
                    <div class="form-group" style="display: block;">
                        <label>Txt Confirm to Client</label>
                        <button type="button" class="btn btn-secondary" @onclick="SendTxtConfirmation">Txt Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}


@code {
    public DateTime Fmdate { get; set; } = DateTime.Now.Date;
    public DateTime Todate { get; set; } = DateTime.Now.Date;

    private ApplicationUser user = default!;

    private List<Bkg_Booking> bookings = new();
    private List<Bkg_User> users = new();
    private List<Bkg_Property> properties = new();
    private Bkg_Booking currentBooking = new();
    private Bkg_Booking originalBooking = new();
    private Bkg_Booking orgnBkg = new();
    private DateTime orgnArrive;
    private DateTime orgnDepart;
    private int orgnPropertyId = 0;

    private bool showModal = false;
    private bool sendConfirmMsg = false;
    private bool allDatesAvailable = true;
    private string modalTitle = string.Empty;
    private string modalMessage = string.Empty;
    private string searchUsername = string.Empty;
    private string searchStatus = string.Empty;
    private DateTime? searchFromDate;
    private DateTime? searchToDate;
    private int? searchPropertyId;
    private string adhocConfirm = string.Empty;



    private Bkg_User currentUser = new();
    private Bkg_Engine bkg_Engine;

    public EmailMessage emailMessage { get; set; } = new EmailMessage();


    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        if (bkg_Engine == null)
        {
            bkg_Engine = new Bkg_Engine(ApplicationDbContext);
        }
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var userName = user.Identity.Name;
            currentUser = await ApplicationDbContext.bkg_Users.FirstOrDefaultAsync(u => u.UserName == userName);
            // Use the currentUser as needed
        }

        users = await ApplicationDbContext.bkg_Users.ToListAsync() ?? new List<Bkg_User>();
        properties = await ApplicationDbContext.bkg_Properties.ToListAsync() ?? new List<Bkg_Property>();
        await LoadBookings();
    }

    private async Task LoadBookings()
    {
        var query = ApplicationDbContext.bkg_Bookings
                    .Include(b => b.Bkg_User)
                    .Include(b => b.Bkg_Property)
                    .Where(b => b.BookingStatus != "Closed")
                    .AsQueryable();

        // Order by a specific field, for example, DateArrive
        query = query.OrderBy(b => b.DateArrive);
        bookings = await query.ToListAsync();

        // bookings = await ApplicationDbContext.bkg_Bookings
        //     .Include(b => b.Bkg_User)
        //     .Include(b => b.Bkg_Property)
        //     .Where(b => b.BookingStatus != "Closed")
        //     .ToListAsync() ?? new List<Bkg_Booking>();
    }
    private DateTime AddOneDay(DateTime date)
    {
        return date.AddDays(1);
    }
    private DateTime SubOneDay(DateTime date)
    {
        return date.AddDays(-1);
    }

    private void DteAriveChnge(Syncfusion.Blazor.Calendars.ChangedEventArgs<DateTime?> args)
    {
        Fmdate = args.Value ?? DateTime.Now.Date;
        if (Todate <= Fmdate)
        {
            Todate = AddOneDay(Fmdate);
            currentBooking.DateArrive = Fmdate;
            currentBooking.DateDepart = Todate;
            StateHasChanged();
        }
    }
    private void DteDepartChnge(Syncfusion.Blazor.Calendars.ChangedEventArgs<DateTime?> args)
    {
        Todate = args.Value ?? DateTime.Now.Date;
        if (Todate <= Fmdate)
        {

            Fmdate = SubOneDay(Todate);
            currentBooking.DateArrive = Fmdate;
            currentBooking.DateDepart = Todate;

            StateHasChanged();
        }
    }


    private void EditBooking(Bkg_Booking booking)
    {
        orgnBkg = new();

        currentBooking = booking;
        orgnBkg.DateArrive = currentBooking.DateArrive; Fmdate = booking.DateArrive;
        orgnBkg.DateDepart = currentBooking.DateDepart; Todate = booking.DateDepart;
        orgnBkg.PropertyId = currentBooking.PropertyId;
        orgnBkg.BookingStatus = currentBooking.BookingStatus;
        orgnBkg.UserId = currentBooking.UserId;
        orgnBkg.BookingId = currentBooking.BookingId;
        orgnBkg.BookingComments = currentBooking.BookingComments;

        modalTitle = "Edit Booking";
        modalMessage = "";
        showModal = true;
    }

    private void OpenAddModal()
    {
        currentBooking = new Bkg_Booking();
        currentBooking.DateArrive = DateTime.Now.Date;
        currentBooking.DateDepart = DateTime.Now.Date.AddDays(1);
        //perhaps need to

        modalTitle = "Add New Booking";
        showModal = true;
    }

    private async Task SaveBooking()
    {
        currentBooking.Bkg_User = await ApplicationDbContext.bkg_Users.FindAsync(currentBooking.UserId);
        currentBooking.Bkg_Property = await ApplicationDbContext.bkg_Properties.FindAsync(currentBooking.PropertyId);
        currentBooking.DateArrive = Fmdate; currentBooking.DateDepart = Todate;



        // if a new booking then we need to Create it else Change it.
        Bkg_Engine bkg_Engine = new Bkg_Engine(ApplicationDbContext);

        // currentBooking.DateArrive = Fmdate; currentBooking.DateDepart = Todate;

        if (currentBooking.BookingId == 0) // A new booking
        {
            var savedOK = await bkg_Engine.CreateBookingAsync(currentBooking);
            if (!savedOK)
            {
                modalMessage = "Booking Not possible - Likely date not available!";
                allDatesAvailable = false;
                showModal = true;
            }
            else
            {
                showModal = false;
                modalMessage = "";
            }
        }
        else // editing existing bkg
        {
            var savedOK = await bkg_Engine.EditBookingAsync(orgnBkg, currentBooking);
            if (!savedOK)
            {
                modalMessage = "Could not save changes to this Booking";
                // need to return the currentBooking to the orgnBkg.
                currentBooking.DateArrive = orgnBkg.DateArrive;
                currentBooking.DateDepart = orgnBkg.DateDepart;
                currentBooking.PropertyId = orgnBkg.PropertyId;
                currentBooking.BookingStatus = orgnBkg.BookingStatus;
                currentBooking.BookingComments = orgnBkg.BookingComments;
                currentBooking.UserId = orgnBkg.UserId;
                allDatesAvailable = false;
                showModal = true;
            }
            else
            {
                showModal = false;
                modalMessage = "";
            }

        }

        //  showModal = false;
        await LoadBookings();
        // StateHasChanged();



        // if (isAvailable())
        // {
        //     currentBooking.BookingStatus = "Confirmed";
        // }
        // else
        // {
        //     currentBooking.BookingStatus = "Requested";
        // }
        // currentBooking.Bkg_User = await ApplicationDbContext.bkg_Users.FindAsync(currentBooking.UserId);
        // currentBooking.Bkg_Property = await ApplicationDbContext.bkg_Properties.FindAsync(currentBooking.PropertyId);

        // if (currentBooking.BookingId == 0)
        // {
        //     ApplicationDbContext.bkg_Bookings.Add(currentBooking);
        // }
        // else
        // {
        //     ApplicationDbContext.bkg_Bookings.Update(currentBooking);
        // }
        // await ApplicationDbContext.SaveChangesAsync();
        // await LoadBookings();
        // showModal = false;
    }

    private async Task DeleteBooking(int bookingId)
    {
        var booking = await ApplicationDbContext.bkg_Bookings.FindAsync(bookingId);
        if (booking != null)
        {
            try
            {
                await bkg_Engine.DeleteBookingAsync(booking);
                await LoadBookings();
            }
            catch (Exception ex)
            {
                modalTitle = "Error found deleting this Booking";
                modalMessage = ex.ToString();
                // allDatesAvailable = false;
                showModal = true;
            }

            // await LoadBookings();
        }


        // var booking = await ApplicationDbContext.bkg_Bookings.FindAsync(bookingId);
        // if (booking != null)
        // {
        //     ApplicationDbContext.bkg_Bookings.Remove(booking);
        //     await ApplicationDbContext.SaveChangesAsync();
        //     await LoadBookings();
        // }
    }

    private void CloseModal()
    {
        modalMessage = "";
        allDatesAvailable = true; //for next time it is opened
        showModal = false;
    }
    private void CloseConfirmModal()
    {
        sendConfirmMsg = false;
    }

    private async Task SearchBookings()
    {
        var query = ApplicationDbContext.bkg_Bookings
            .Include(b => b.Bkg_User)
            .Include(b => b.Bkg_Property)
            .Where(b => b.BookingStatus != "Closed")
            .AsQueryable();

        if (!string.IsNullOrEmpty(searchUsername))
        {
            // if numeric then is Bkg Ref else User name
            if (IsNumeric(searchUsername))
            {
                query = query.Where(b => b.BookingId == int.Parse(searchUsername));
            }
            else
            {
                query = query.Where(b => b.Bkg_User.UserName.Contains(searchUsername));
            }
            // query = query.Where(b => b.Bkg_User.UserName.Contains(searchUsername));
        }
        if (!string.IsNullOrEmpty(searchStatus))
        {
            query = query.Where(b => b.BookingStatus.Contains(searchStatus));
        }
        if (searchFromDate.HasValue)
        {
            query = query.Where(b => b.DateArrive >= searchFromDate.Value);
        }

        if (searchToDate.HasValue)
        {
            query = query.Where(b => b.DateDepart <= searchToDate.Value);
        }

        if (searchPropertyId.HasValue)
        {
            query = query.Where(b => b.PropertyId == searchPropertyId.Value);
        }
        // Order by a specific field, for example, DateArrive
        query = query.OrderBy(b => b.DateArrive);
        bookings = await query.ToListAsync();
    }
    private async Task SearchBookingsA()
    {
        var query = ApplicationDbContext.bkg_Bookings
            .Include(b => b.Bkg_User)
            .Include(b => b.Bkg_Property)
            .Where(b => b.BookingStatus != "Closed")
            .AsQueryable();

        if (!string.IsNullOrEmpty(searchUsername))
        {
            if (IsNumeric(searchUsername))
            {
                query = query.Where(b => b.BookingId == int.Parse(searchUsername));
            }
            else
            {
                query = query.Where(b => b.Bkg_User.UserName.Contains(searchUsername));
            }
        }
        if (!string.IsNullOrEmpty(searchStatus))
        {
            query = query.Where(b => b.BookingStatus.Contains(searchStatus));
        }
        if (searchFromDate.HasValue)
        {
            query = query.Where(b => b.DateArrive >= searchFromDate.Value);
        }

        if (searchToDate.HasValue)
        {
            query = query.Where(b => b.DateDepart <= searchToDate.Value);
        }

        if (searchPropertyId.HasValue)
        {
            query = query.Where(b => b.PropertyId == searchPropertyId.Value);
        }

        // Order by a specific field, for example, DateArrive
        query = query.OrderBy(b => b.DateArrive);

        bookings = await query.ToListAsync();
    }
    private void ClearSearch()
    {
        searchUsername = string.Empty;
        searchStatus = string.Empty;
        searchFromDate = null;
        searchToDate = null;
        searchPropertyId = null;
    }
    public static bool IsNumeric(string value)
    {
        return double.TryParse(value, out _);
    }
    // private bool isAvailable()
    // {
    //     bool result = false;
    //     if (currentBooking.BookingId == 0)
    //     {
    //         // a new booking so see if available
    //         var dte = currentBooking.DateArrive;
    //         while (dte <= currentBooking.DateDepart)
    //         {
    //             var avail = ApplicationDbContext.bkg_Availabilities
    //                 .Where(a => a.Bkg_PropertyId == currentBooking.PropertyId && a.DateAvailable == dte)
    //                 .FirstOrDefault();
    //             if (avail != null)
    //             {
    //                 if (avail.Available)
    //                 {
    //                     result = true;
    //                 }
    //                 else
    //                 {
    //                     result = false;
    //                     break;
    //                 }
    //             }
    //             else
    //             {
    //                 result = false;
    //                 break;
    //             }
    //             dte = dte.AddDays(1);
    //         }
    //     }
    //     else
    //     {
    //         ApplicationDbContext.bkg_Bookings.Update(currentBooking);
    //     }









    //     var isAvail = false;

    //     return isAvail;
    // }
    // private bool isAvailable(DateTime fmdte, DateTime todte, int propId)
    // {
    //     bool result = false;
    //     var dte = fmdte;
    //     while (dte <= todte)
    //     {
    //         var avail = ApplicationDbContext.bkg_Availabilities
    //             .Where(a => a.Bkg_PropertyId == propId && a.DateAvailable == dte)
    //             .FirstOrDefault();
    //         if (avail != null)
    //         {
    //             if (avail.Available)
    //             {
    //                 result = true;
    //             }
    //             else
    //             {
    //                 result = false;
    //                 break;
    //             }
    //         }
    //         else
    //         {
    //             result = false;
    //             break;
    //         }
    //         dte = dte.AddDays(1);
    //     }
    //     return result;

    // }
    // private bool chngAvailableStatus(DateTime fmdte, DateTime todte, int propId, bool isavail, string status)
    // {
    //     bool result = true;
    //     DateTime dte = fmdte;
    //     while (dte <= todte)
    //     {
    //         var existingRecord = ApplicationDbContext.bkg_Availabilities
    //             .FirstOrDefault(a => a.Bkg_PropertyId == propId && a.DateAvailable == dte);

    //         if (existingRecord != null)
    //         {
    //             existingRecord.Available = isavail;
    //             existingRecord.AvailabilityStatus = status;
    //         }
    //         else
    //         {
    //             result = false;
    //             break;
    //         }
    //         dte = dte.AddDays(1);
    //     }
    //     return result;
    // }

    private void SendConfirmationModal(int bookingId)
    {
        currentBooking = bookings.FirstOrDefault(b => b.BookingId == bookingId);
        sendConfirmMsg = true;
    }

    private void SendEmailConfirmation()
    {
        string destination = currentBooking.Bkg_User.UserEmail;
        SendEmailConfirmation(destination);
    }
    private void SendTxtConfirmation()
    {
        string txtrept = Chk_E_164_Phone(currentBooking.Bkg_User.UserPhone);
        SendTxtConfirmation(txtrept);
    }
    private void SendAdhocConfirmation()
    {
        bool isEmail = true;
        string sendtoWho = string.Empty;
        // if Me then send to the logged in user
        if (adhocConfirm.ToLower() == "me" || adhocConfirm.Length == 0)
        {
            adhocConfirm = currentUser.UserEmail;
            isEmail = true;
        }
        else if (IsNumeric(adhocConfirm))
        {
            adhocConfirm = Chk_E_164_Phone(adhocConfirm);
            isEmail = false;
        }
        else
        {
            if (!emailMessage.IsValidEmail(adhocConfirm))
            {
                modalMessage = "Invalid Email or Phone Number";
                //                showModal = true;
                adhocConfirm = string.Empty;
                sendConfirmMsg = false;
                return; // do nothing and say nothing
            }
            isEmail = true;
        }
        if (isEmail)
        {
            SendEmailConfirmation(adhocConfirm);
        }
        else
        {
            SendTxtConfirmation(adhocConfirm);
        }

        adhocConfirm = string.Empty;
        sendConfirmMsg = false;

    }
    private void SendEmailConfirmation(string emailTo)
    {
        string subjectMsg = string.Concat("BkgRef: ", currentBooking.BookingId.ToString(), " for ", currentBooking.Bkg_Property.Name,
    " from ", currentBooking.DateArrive.Date.ToString("d"), " to ", currentBooking.DateDepart.Date.ToString("d"));
        // emailMessage = new EmailMessage(currentBooking.Bkg_User.UserEmail,
        //     "Booking Confirmation", "", currentBooking.DateArrive, currentBooking.DateDepart, currentBooking.Bkg_User);

        // emailMessage.Subject = subjectMsg;
#if !DEBUG
        // Using TNZ
        var apiUser = new TNZApiUser()  // this shoild come from configuration injection
            {
                AuthToken = configuration["TNZ:AuthToken"]
            };
        var client = new TNZApiClient(apiUser);

        var reponseEmail = client.Messaging.Email.SendMessage(
            fromEmail: configuration["TNZ:fromEmail"],  // this should come from configuration injection
            emailSubject: subjectMsg,
            messagePlain: ConfirmBkgMsg(),
            destination: emailTo
        );
#endif
        sendConfirmMsg = false;
    }
    private void SendTxtConfirmation(string txtrept)
    {
        string subjectMsg = string.Concat("BkgRef: ", currentBooking.BookingId.ToString(), " for ", currentBooking.Bkg_Property.Name,
        " from ", currentBooking.DateArrive.Date.ToString("d"), " to ", currentBooking.DateDepart.Date.ToString("d"));

        // emailMessage = new EmailMessage(currentBooking.Bkg_User.UserEmail,
        //     "Booking Confirmation", "", currentBooking.DateArrive, currentBooking.DateDepart, currentBooking.Bkg_User);

        // emailMessage.Subject = subjectMsg;
        // Using TNZ
#if !DEBUG
        var apiUser = new TNZApiUser()  // this shoild come from configuration injection
            {
                AuthToken = configuration["TNZ:AuthToken"]
            };
        var client = new TNZApiClient(apiUser);

        var response = client.Messaging.SMS.SendMessage
            (
                destination: txtrept,
                messageText: ConfirmBkgMsg()
            );
#endif
        sendConfirmMsg = false;
    }
    private string ConfirmBkgMsg()
    {
        StringBuilder sb = new StringBuilder();
        sb.Append("Kia ora ");
        sb.Append(currentUser.UserFirstName);
        sb.Append(" ");
        sb.Append(currentUser.UserLastName);
        sb.Append("\n\n");
        sb.Append("Your booking has been confirmed for ");
        sb.Append(currentBooking.Bkg_Property.Name);
        sb.Append(" arriving after mid-day ");
        sb.Append(currentBooking.DateArrive.Date.ToString("d"));
        sb.Append(" departing before mid-day");
        sb.Append(currentBooking.DateDepart.Date.ToString("d"));
        sb.Append("\n\n");
        sb.Append("Address is\r\n" +
                 "        22 Fitzpatrick St\r\n" +
                 "        Newlands\r\n" +
                 "        Wellington 6037\r\n" +
                 "Access is best from Stewart Drive.Either from the north where you would exit SH1 at Johnsonville or from the South turning into Newlands. Turn into Fitzpatrick St from Stewart Drive is best as other routes(courtesy of the map apps) send you around a very narrow road.We are on the left corner of the 2nd street on the left going up Fitzpatrick St.\r\n" +
                 "Payment is $30 for the night with NZMCA Memebrship {3}, payable in advance please to our bank account.\r\n" +
                 "        Ronald Pontifex\r\n" +
                 "        03 0525 0253043 000\r\n" +
                 "(We have Wise Card if that suits you better.)\r\n\r\n" +
                 "Please text us on arrival and we shall come out to meets you etc.\r\n" +
                 "Again many thanks\r\n" +
                 "Ron Pontifex\r\n" +
                 "WELLINGTON New Zealand\r\n" +
                 "Ph 027 304 2002\r\n" +
                 "E - Mail : rvpark@pontifex.nz\r\n");
        return sb.ToString();
    }
    private string Chk_E_164_Phone(string phne)
    {
        string srtn = string.Empty;
        if (phne.Length > 0)
        {
            if (phne.StartsWith("+")) // then likely in the corect format already
            {
                srtn = phne.Trim();
            }
            else if (phne.StartsWith("0"))// then likely miss country code so remove the "0" and add "+64"
            {
                srtn = string.Concat("+64" + phne[1..]); // this prefix should be a configurable for the ountry the app is being run in.
            }
        }
        return srtn;
    }

}

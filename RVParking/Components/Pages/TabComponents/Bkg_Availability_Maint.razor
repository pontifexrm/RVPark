@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@using RVParking.Data


@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject ApplicationDbContext ApplicationDbContext
@* @inject Bkg_UserService bkg_UserService
 *@

<h4>Create Update or Delete Bkg_Availability Records</h4>



<div class="search-bar">
    <div class="form-group" style="display:flex;flex-direction:row; margin-bottom: 1%;">
        <div class="form-group" style="max-width: 60%; text-align:center;">
            <label for="bkgType">Select Property</label>
            <select class="form-control" id="bkgType" @bind="searchPropertyId">
                <option value="">All Properties</option>
                @foreach (var property in BkgPropertiesAvail)
                {
                    <option value="@property.PropertyId">@property.Name</option>
                }
            </select>
        </div>
        <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
            <label for="fmdate">From Date</label>
            <InputDate @bind-Value="searchFromDate" class="form-control" id="fmdate" />
        </div>
        <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
            <label for="todate">To Date</label>
            <InputDate @bind-Value="searchToDate" class="form-control" id="todate" />
        </div>
        <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
            <label for="availStatus">Availability Status</label>
            <select class="form-control" id="availStatus" @bind="searchStatus">
                <option value="">All Statuses</option>
                <option value="NA">Not Available</option>
                <option value="Booked">Booked</option>
                <option value="CLOSED">Closed</option>
            </select>
        </div>
        <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
            <label for="isAvail">Availability</label>
            <select class="form-control" id="isAvail" @bind="searchIsAvail">
                <option value="">All</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
            </select>
        </div>
        <button class="bi form-control" style="margin-top: 28px; width: 40px; height: 32px; margin-left: 4px;"
        @onclick="ClearSearchAvailability">
            <i class="bi bi-x-lg"></i>
        </button>
        <button class="bi form-control" style="margin-top: 28px; width: 40px; height: 32px; margin-left: 4px;"
        @onclick="SearchAvailability">
            <i class="bi bi-search"></i>
        </button>
@*         <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
            <button class="btn btn-primary" @onclick="SearchAvailability">Search</button>
        </div> *@
    </div>
</div>





@* @if (BkgPropertiesAvail == null || BkgPropertiesAvail.Count == 0)
{
    <p>Loading...</p>
}
else
{
    <div class="form-group" style="display:flex;flex-direction:row; margin-bottom: 1%;">
        <div class="form-group" style="max-width: 60%; text-align:center;">
            <label for="bkgType">Select Property</label>
            <select class="form-control" id="bkgType" @bind="BkgType">
                @foreach (var property in BkgPropertiesAvail)
                {
                    <option value="@property.PropertyId">@property.Name</option>
                }
            </select>

        </div>


        <div class="form-group" style="text-align:center; max-width: 60%; margin-left: 1%">
            <label for="bkgAvail">Availability</label>
            <select class="form-control" id="bkgAvail" @bind="isAvail">
                <option style="text-align:center;" value="Yes">Is Available</option>
                <option style="text-align:center;" value="No">Not Available</option>
            </select>
        </div>

        <div class="form-group" style="max-width: 40%; text-align:center; margin-left: 2%;">
            @* <input type="checkbox" @bind="isChecked" /> Check to delete *@
@*            <label for="bkgAvail">To Delete ?</label>
            <select class="form-control" id="toDelete" style="color:red;" @bind="toDelete">
                <option value="no"></option>
                <option value="YES">*DELETE*</option>
            </select>
        </div>
    </div>
    <div class="form-group" style="display:flex;flex-direction:row; margin-bottom: 1%">
        <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 0%">
            <label for="fmdate">From Date</label>
            <InputDate @bind-Value=Fmdate class="form-control" id="fmdate" />
            @* <ValidationMessage For="() => emailMessage.Fmdate" /> *@
@*         </div>
        <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
            <label for="todate">To Date</label>
            <InputDate @bind-Value=Todate class="form-control" id="todate" />
 *@            @* <ValidationMessage For="() => emailMessage.Todate" /> 
        </div>
        <div class="form-group" style="text-align:center; max-width: 60%; margin-left: 1%">
            <label for="bkgAvailStatus">Status</label>
            <select class="form-control" id="bkgAvailStatus" @bind="status">
                <option style="text-align:center;" value=""></option>
                <option style="text-align:center;" value="NA">Not Available</option>
                <option style="text-align:center;" value="Booked">Booked</option>
                <option style="text-align:center;" value="CLOSED">Closed</option>
            </select>
        </div>
    </div>
    <div>
        <button class="btn btn-primary" style="min-width: 28%; align-content: center;" @onclick="CrudBkBkgAvailablilty">Create Update or Delete Bkg_Availability</button>
    </div>
} *@

@if (availabilities == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table" style="max-width: 60%;">
        <thead>
            <tr>
                <th style="border: 1px solid #929292;">Date</th>
                <th style="border: 1px solid #929292;">Property Name</th>
                <th style="border: 1px solid #929292;">Availability</th>
                <th style="border: 1px solid #929292;">Availability Status</th>
                <th style="border: 1px solid #929292;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var availability in availabilities)
            {
                <tr>
                    <td style="border: 1px solid #929292;">@availability.DateAvailable.ToShortDateString()</td>
                    <td style="border: 1px solid #929292;">@availability.Bkg_Property?.Name</td>
                    <td style="border: 1px solid #929292;">@(availability.Available ? "Y" : "N")</td>
                    <td style="border: 1px solid #929292;">@availability.AvailabilityStatus</td>
                    <td style="border: 1px solid #929292;">
                        <div class="tab-content" style="display:flex;flex-direction:row;">
                            <button class="bi form-control" style="width: 40px; height: 32px;"
                            @onclick="() => EditBkgAvailablilty(availability)">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="bi form-control" style="width: 40px; height: 32px;"
                            @onclick="() => DeleteBkgAvailability(availability)">
                                <i class="bi bi-trash3" style="block-size:max-content;"></i>
                            </button>
                        </div>
                    </td>

                </tr>
            }
        </tbody>
    </table>
}






@code {
    // [Parameter]
    // public List<Bkg_Property> BkgPropertiesAvail { get; set; }
    private string BkgType = "RVPark On Fitz";
    private string isAvail = "Yes";
    public DateTime Fmdate { get; set; } = DateTime.Now.Date;
    public DateTime Todate { get; set; } = DateTime.Now.Date;
    private bool allDatesAvailable = false;
    private string toDelete = "no";
    private string status = string.Empty;
    private ApplicationDbContext _dbContext;

    private List<Bkg_Property> BkgPropertiesAvail = new List<Bkg_Property>();
    private List<Bkg_Availability> availabilities = new List<Bkg_Availability>();

    private int? searchPropertyId;
    private DateTime? searchFromDate;
    private DateTime? searchToDate;
    private string searchStatus = string.Empty;
    private string searchIsAvail = string.Empty;

    protected override async Task OnInitializedAsync()
    {

        BkgPropertiesAvail = await ApplicationDbContext.bkg_Properties.ToListAsync();
        BkgType = "1"; 
        await LoadAvailabilities();
    }
    private async Task LoadAvailabilities()
    {
        var query = ApplicationDbContext.bkg_Availabilities
            .Include(a => a.Bkg_Property)
            .AsQueryable();

        if (searchPropertyId.HasValue)
        {
            query = query.Where(a => a.Bkg_PropertyId == searchPropertyId.Value);
        }

        if (searchFromDate.HasValue)
        {
            query = query.Where(a => a.DateAvailable >= searchFromDate.Value);
        }

        if (searchToDate.HasValue)
        {
            query = query.Where(a => a.DateAvailable <= searchToDate.Value);
        }

        if (!string.IsNullOrEmpty(searchStatus))
        {
            query = query.Where(a => a.AvailabilityStatus == searchStatus);
        }

        if (!string.IsNullOrEmpty(searchIsAvail))
        {
            bool isAvailable = searchIsAvail == "Yes";
            query = query.Where(a => a.Available == isAvailable);
        }

        availabilities = await query.ToListAsync();
    }

    private async Task SearchAvailability()
    {
        await LoadAvailabilities();
    }

    private void OnBkgTypeChange(ChangeEventArgs e)
    {
        BkgType = e.Value.ToString();
        // Update other fields based on the selected BkgType
        // For example, you can fetch additional data from the database and update the UI
    }
    private async Task CrudBkBkgAvailablilty()
    {
        if (toDelete == "YES")
        {
            var recordsToDelete = ApplicationDbContext.bkg_Availabilities
                .Where(a => a.Bkg_PropertyId == int.Parse(BkgType) && a.DateAvailable >= Fmdate && a.DateAvailable <= Todate);

            ApplicationDbContext.bkg_Availabilities.RemoveRange(recordsToDelete);
        }
        else
        {
            DateTime dte = Fmdate;
            while (dte <= Todate)
            {
                var existingRecord = ApplicationDbContext.bkg_Availabilities
                    .FirstOrDefault(a => a.Bkg_PropertyId == int.Parse(BkgType) && a.DateAvailable == dte);

                if (existingRecord != null)
                {
                    existingRecord.Available = isAvail == "Yes";
                    existingRecord.AvailabilityStatus = status;
                }
                else
                {
                    var newRecord = new Bkg_Availability
                        {
                            Bkg_PropertyId = int.Parse(BkgType),
                            DateAvailable = dte,
                            Available = isAvail == "Yes",
                            AvailabilityStatus = status
                        };
                    ApplicationDbContext.bkg_Availabilities.Add(newRecord);
                }
                dte = dte.AddDays(1);
            }
        }
        await ApplicationDbContext.SaveChangesAsync();
    }

    private void EditBkgAvailablilty(Bkg_Availability availability)
    {
        // Implement the logic to edit the availability record
    }
    private void DeleteBkgAvailability(Bkg_Availability availability)
    {
        // Implement the logic to delete the availability record
    }
    private void ClearSearchAvailability()
    {
        searchPropertyId = null;
        searchFromDate = null;
        searchToDate = null;
        searchStatus = string.Empty;
        searchIsAvail = string.Empty;
        SearchAvailability();
    }
}

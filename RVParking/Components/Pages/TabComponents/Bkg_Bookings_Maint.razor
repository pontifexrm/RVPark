@using RVParking.Data
@using RVParking.Components.Account

@using Microsoft.AspNetCore.Identity.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities




@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor

@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject ApplicationDbContext ApplicationDbContext

<div class="tab-content" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h4>Current Open Bookings</h4>
    </div>
    <div>
        <button class="btn btn-primary" @onclick="OpenAddModal">Add New Booking</button>
    </div>
</div>


<div class="search-bar" style="display:flex;flex-direction:row;">
    <input type="text" style="width: 300px;" placeholder="Search by Client" @bind="searchUsername" />
    <input type="date" style="margin-left: 4px;" @bind="searchFromDate" />
    <input type="date" style="margin-left: 4px;" @bind="searchToDate" />
    <select style="margin-left: 4px;" @bind="searchPropertyId">
        <option value="">Select Property</option>
        @foreach (var property in properties)
        {
            <option value="@property.PropertyId">@property.Name</option>
        }
    </select>
    <button class="bi form-control" style="width: 40px; height: 32px; margin-left: 4px;"
        @onclick="ClearSearch">
        <i class="bi bi-x-lg"></i>
    </button>
    <button class="bi form-control" style="width: 40px; height: 32px; margin-left: 4px;"
           @onclick="SearchBookings">
        <i class="bi bi-search"></i>
    </button>
</div>
<br />

@if (bookings == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th style ="border: 1px solid #929292;">Bkg Username</th>
                <th style="border: 1px solid #929292;">First Name</th>
                <th style="border: 1px solid #929292;">Last Name</th>
                <th style="border: 1px solid #929292;">Property Name</th>
                <th style="border: 1px solid #929292;">Arrival Date</th>
                <th style="border: 1px solid #929292;">Departure Date</th>
                <th style="border: 1px solid #929292;">Status</th>
                <th style="border: 1px solid #929292;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var booking in bookings)
            {
                <tr>
                    <td style="border: 1px solid #929292;">@booking.Bkg_User.UserName</td>
                    <td style="border: 1px solid #929292;">@booking.Bkg_User.UserFirstName</td>
                    <td style="border: 1px solid #929292;">@booking.Bkg_User.UserLastName</td>
                    <td style="border: 1px solid #929292;">@booking.Bkg_Property.Name</td>
                    <td style="border: 1px solid #929292;">@booking.DateArrive.ToShortDateString()</td>
                    <td style="border: 1px solid #929292;">@booking.DateDepart.ToShortDateString()</td>
                    <td style="border: 1px solid #929292;">@booking.BookingStatus</td>
                    @*                     <td>
                        <button class="btn btn-primary" @onclick="() => EditBooking(booking)">Edit</button>
                        <button class="btn btn-danger" @onclick="() => DeleteBooking(booking.BookingId)">Delete</button>
                    </td> *@
                    @* <td style="border: 1px solid #929292;"> *@
                    <td style="border: 1px solid #929292;">
                        <div class="tab-content" style="display:flex;flex-direction:row;">
                            <button class="bi form-control" style="width: 40px; height: 32px;"
                            @onclick="() => EditBooking(booking)">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="bi form-control" style="width: 40px; height: 32px;"
                            @onclick="() => DeleteBooking(booking.BookingId)">
                                <i class="bi bi-trash3" style="block-size:max-content;"></i>
                            </button>
                        </div>
                    </td>

                </tr>
            }
        </tbody>
    </table>
}

@* <button class="btn btn-primary" @onclick="OpenAddModal">Add New Booking</button> *@

<!-- Modal Dialog for Editing/Adding Bookings -->
@if (showModal)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@modalTitle</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>

                </div>
                <div class="modal-header">@modalMessage</div>
                <div class="modal-body">
                    <EditForm Model="currentBooking" OnValidSubmit="SaveBooking">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="form-group">
                            <label>Bkg User</label>
                            <InputSelect @bind-Value="currentBooking.UserId" class="form-control">
                                @foreach (var user in users)
                                {
                                    <option value="@user.UserId">@user.UserName</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group">
                            <label>Property</label>
                            <InputSelect @bind-Value="currentBooking.PropertyId" class="form-control">
                                @foreach (var property in properties)
                                {
                                    <option value="@property.PropertyId">@property.Name</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group">
                            <label>Arrival Date</label>
                            <InputDate @bind-Value="currentBooking.DateArrive" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Departure Date</label>
                            <InputDate @bind-Value="currentBooking.DateDepart" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Status <small>(Requested,Confirmed,Paid,Arrived,Closed,Cancelled)</small></label>
                            <InputText @bind-Value="currentBooking.BookingStatus" class="form-control" />
                        </div>
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private ApplicationUser user = default!;

    private List<Bkg_Booking> bookings = new();
    private List<Bkg_User> users = new();
    private List<Bkg_Property> properties = new();
    private Bkg_Booking currentBooking = new();
    private bool showModal = false;
    private string modalTitle = string.Empty;
    private string modalMessage = string.Empty;
    private string searchUsername = string.Empty;
    private DateTime? searchFromDate;
    private DateTime? searchToDate;
    private int? searchPropertyId;
    private Bkg_User currentUser = new();

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var userName = user.Identity.Name;
            currentUser = await ApplicationDbContext.bkg_Users.FirstOrDefaultAsync(u => u.UserName == userName);
            // Use the currentUser as needed
        }

        users = await ApplicationDbContext.bkg_Users.ToListAsync() ?? new List<Bkg_User>();
        properties = await ApplicationDbContext.bkg_Properties.ToListAsync() ?? new List<Bkg_Property>();
        await LoadBookings();
    }

    private async Task LoadBookings()
    {
        bookings = await ApplicationDbContext.bkg_Bookings
            .Include(b => b.Bkg_User)
            .Include(b => b.Bkg_Property)
            .Where(b => b.BookingStatus != "Closed")
            .ToListAsync() ?? new List<Bkg_Booking>();
    }
   
    private void EditBooking(Bkg_Booking booking)
    {
        currentBooking = booking;
        modalTitle = "Edit Booking";
        modalMessage = "Booking Availablility is NOT checked as a results of changes you may make here. Double Booking Is Possible !!!!";
        showModal = true;
    }

    private void OpenAddModal()
    {
        currentBooking = new Bkg_Booking();
        currentBooking.DateArrive = DateTime.Now;
        currentBooking.DateDepart = DateTime.Now.AddDays(1);
        //perhaps need to

        modalTitle = "Add New Booking";
        showModal = true;
    }

    private async Task SaveBooking()
    {
        currentBooking.Bkg_User = await ApplicationDbContext.bkg_Users.FindAsync(currentBooking.UserId);
        currentBooking.Bkg_Property = await ApplicationDbContext.bkg_Properties.FindAsync(currentBooking.PropertyId);

        if (currentBooking.BookingId == 0)
        {
            ApplicationDbContext.bkg_Bookings.Add(currentBooking);
        }
        else
        {
            ApplicationDbContext.bkg_Bookings.Update(currentBooking);
        }
        await ApplicationDbContext.SaveChangesAsync();
        await LoadBookings();
        showModal = false;
    }

    private async Task DeleteBooking(int bookingId)
    {
        var booking = await ApplicationDbContext.bkg_Bookings.FindAsync(bookingId);
        if (booking != null)
        {
            ApplicationDbContext.bkg_Bookings.Remove(booking);
            await ApplicationDbContext.SaveChangesAsync();
            await LoadBookings();
        }
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private async Task SearchBookings()
    {
        var query = ApplicationDbContext.bkg_Bookings
            .Include(b => b.Bkg_User)
            .Include(b => b.Bkg_Property)
            .Where(b => b.BookingStatus != "Closed")
            .AsQueryable();

        if (!string.IsNullOrEmpty(searchUsername))
        {
            query = query.Where(b => b.Bkg_User.UserName.Contains(searchUsername));
        }

        if (searchFromDate.HasValue)
        {
            query = query.Where(b => b.DateArrive >= searchFromDate.Value);
        }

        if (searchToDate.HasValue)
        {
            query = query.Where(b => b.DateDepart <= searchToDate.Value);
        }

        if (searchPropertyId.HasValue)
        {
            query = query.Where(b => b.PropertyId == searchPropertyId.Value);
        }

        bookings = await query.ToListAsync();
    }
    
    private void ClearSearch()
    {
        searchUsername = string.Empty;
        searchFromDate = null;
        searchToDate = null;
        searchPropertyId= null;
    }
}

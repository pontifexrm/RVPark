@page "/mybookings"
@rendermode InteractiveServer
<PageTitle>RV Park My Bookings</PageTitle>

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@using RVParking.Data
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity.EntityFrameworkCore

@using TNZAPI.NET;
@using TNZAPI.NET.Core;
@using TNZAPI.NET.Api.Addressbook.Contact.Dto;


@inject AuthenticationStateProvider AuthenticationStateProvider

@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject ApplicationDbContext ApplicationDbContext

@inject IConfiguration configuration

<section class="card-list" >

    <a class="card-body" style="border: 1px solid #929292; margin-left: 1%; text-align:center;">
        <h4> Request and Add a new Booking.</h4>
        <div class="form-group" style="display:flex;flex-direction:row; text-align:center;">
            <div class="form-group" style="text-align:center; margin-left: 1%;">
                <label>Property</label>
                <InputSelect @bind-Value="currentBooking.PropertyId" select class="form-control">
                    <option value="">Select Property</option>
                    @foreach (var property in BkgProperties)
                    {
                        <option value="@property.PropertyId">@property.Name</option>
                    }
                </InputSelect>
            </div>
            <div class="form-group" style=" text-align:center; margin-left: 1%">
                <label for="fmdate">Arriving</label>
                <InputDate @bind-Value=Fmdate class="form-control" id="fmdate" />
            </div>
            <div class="form-group" style="text-align:center; margin-left: 1%;">
                <label for="todate">Departing</label>
                <InputDate @bind-Value=Todate class="form-control" id="todate" />
            </div>
        </div>
        <div>
            <button class="btn btn-primary" style="min-width: 90%; text-align:center; " @onclick="CheckBkgRequest">Request Booking</button>
        </div>
    </a>    
    <a class="card-body" style="border: 1px solid #929292;margin-left: 1%; text-align:center;">
        <h4> User Details.</h4>
        <div class="form-group" style="display:flex;flex-direction:row;">
            <div class="form-group" style=" text-align:center; margin-left: 1%">
                <label for="username">User Name</label>
                <InputText class="form-control" @bind-Value=@currentUser.UserName readonly="true" id="username" />
            </div>
            <div class="form-group" style=" text-align:center; margin-left: 1%">
                <label for="firstname">First Name</label>
                <InputText class="form-control" @bind-Value=@currentUser.UserFirstName readonly="true" id="firstname" />
            </div>
            <div class="form-group" style=" text-align:center; margin-left: 1%">
                <label for="lastname">Last Name</label>
                <InputText class="form-control" @bind-Value=@currentUser.UserLastName readonly="true" id="lastname" />
            </div>

            <div class="form-group" style="text-align:center; margin-left: 2%;">
                <label for="userphone">Phone</label>
                <InputText class="form-control" @bind-Value=@currentUser.UserPhone readonly="true" id="userphone" />
            </div>
        </div>
    </a>            
</section>

<h4>View, Change or Delete Existing Bookings</h4>
@if (bookings == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th style="border: 1px solid #929292;">Bkg Username</th>
                    <th style="border: 1px solid #929292;">First Name</th>
                    <th style="border: 1px solid #929292;">Last Name</th>
                    <th style="border: 1px solid #929292;">Property Name</th>
                    <th style="border: 1px solid #929292;">Arrival Date</th>
                    <th style="border: 1px solid #929292;">Departure Date</th>
                    <th style="border: 1px solid #929292;">Bkg Ref</th>
                    <th style="border: 1px solid #929292;">Status</th>
                    <th style="border: 1px solid #929292;"><small>Edit Delete Confirm</small></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var booking in bookings)
                {
                    <tr>
                        <td style="border: 1px solid #929292;">@booking.Bkg_User.UserName</td>
                        <td style="border: 1px solid #929292;">@booking.Bkg_User.UserFirstName</td>
                        <td style="border: 1px solid #929292;">@booking.Bkg_User.UserLastName</td>
                        <td style="border: 1px solid #929292;">@booking.Bkg_Property.Name</td>
                        <td style="border: 1px solid #929292;">@booking.DateArrive.ToShortDateString()</td>
                        <td style="border: 1px solid #929292;">@booking.DateDepart.ToShortDateString()</td>
                        <td style="border: 1px solid #929292;">@booking.BookingId</td>
                        <td style="border: 1px solid #929292;">@booking.BookingStatus</td>
                        <td style="border: 1px solid #929292;">
                            <div class="tab-content" style="display:flex;flex-direction:row;">
                                <button class="bi form-control" style="width: 40px; height: 32px;"
                                @onclick="() => EditBooking(booking)">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="bi form-control" style="width: 40px; height: 32px;"
                                @onclick="() => DeleteBooking(booking.BookingId)">
                                    <i class="bi bi-trash3" style="block-size:max-content;"></i>
                                </button>
                                <button class="bi form-control" style="width: 70px; height: 32px;"
                                @onclick="() => SendEmailConfirmation(booking.BookingId)">
                                    <i class="bi bi-chat-text" style="block-size:max-content;"></i>
                                    <i class="bi bi-envelope-arrow-up" style="block-size:max-content;"></i>
                                </button>
                            </div>
                        </td>

                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- Modal Dialog for Editing/Adding Bookings for current user. -->
@if (showModal)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@modalTitle</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>

                </div>
                @if (!string.IsNullOrEmpty(modalMessage))
                {
                    <div class="modal-header" style="color:midnightblue">@modalMessage</div>
                }

                <div class="modal-body">
                    <EditForm Model="currentBooking" OnValidSubmit="SaveBooking">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                     @*<div class="form-group">
                            <label>Bkg User</label>
                            <InputSelect @bind-Value="currentBooking.UserId" class="form-control">
                                @foreach (var user in users)
                                {
                                    <option value="@user.UserId">@user.UserName</option>
                                }
                            </InputSelect>
                        </div> *@
                        <div class="form-group">
                            <label>Property</label>
                            <InputSelect @bind-Value="currentBooking.PropertyId" class="form-control">
                                @foreach (var property in BkgProperties)
                                {
                                    <option value="@property.PropertyId">@property.Name</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group">
                            <label>Arrival Date</label>
                            <InputDate @bind-Value="currentBooking.DateArrive" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Departure Date</label>
                            <InputDate @bind-Value="currentBooking.DateDepart" class="form-control" />
                        </div>

                        <div class="form-group">
                            <label>Status <small>(Requested,Confirmed,Paid,Arrived,Closed,Cancelled)</small></label>
                            <InputText @bind-Value="currentBooking.BookingStatus" class="form-control" />
                        </div>

                        @if (allDatesAvailable)
                        {
                            <button type="submit" class="btn btn-primary">Save</button>
                        }
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@if (sendConfirmMsg)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm your booking by Txt or Email</h5>
                    <button type="button" class="btn-close" @onclick="CloseConfirmModal"></button>
                </div>
                <div class="modal-header" >
                    <div class="form-group" style="display: block;">
                        <label>Confirmation to my Email</label>
                        <button type="button" class="btn btn-secondary" @onclick="SendEmailConfirmation">Email Confirmation</button>
                    </div>
                    <div class="form-group" style="display: block;">
                        <label>Txt Confirmation to Phone</label>
                        <button type="button" class="btn btn-secondary" @onclick="SendTxtConfirmation">Txt Confirmation</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string BkgType = "RVPark On Fitz";
    private string isAvail = "Yes";
    public DateTime Fmdate { get; set; } = DateTime.Now.Date;
    public DateTime Todate { get; set; } = DateTime.Now.Date;
    private bool allDatesAvailable = false;
    private string toDelete = "no";
    private string status = string.Empty;
    private int? rqstPropertyId;
    private List<Bkg_Property> BkgProperties = new List<Bkg_Property>();
    private Bkg_Booking currentBooking = new();
    private Bkg_Booking orgnBkg = new();
    private DateTime orgnArrive;
    private DateTime orgnDepart;
    private int orgnPropertyId = 0;

    private Bkg_Booking newBooking = new();

    private string modalTitle = string.Empty;
    private string modalMessage = string.Empty;
    private bool sendConfirmMsg = false;
    private bool showModal = false;

    private List<Bkg_Booking> bookings = new();
    private List<Bkg_User> users = new();
    private Bkg_User currentUser = new();
    private Bkg_Engine? bkg_Engine;

    public EmailMessage emailMessage { get; set; } = new EmailMessage();


    protected override async Task OnInitializedAsync()
    {
        if(bkg_Engine == null)
        {
            bkg_Engine = new Bkg_Engine(ApplicationDbContext);
        }
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var userName = user.Identity.Name;
            currentUser = await ApplicationDbContext.bkg_Users.FirstOrDefaultAsync(u => u.UserName == userName);
            // Use the currentUser as needed
        }
        BkgProperties = await ApplicationDbContext.bkg_Properties.ToListAsync();
        await LoadBookings();

    }
    private async Task LoadBookings() => bookings = await ApplicationDbContext.bkg_Bookings
            .Include(b => b.Bkg_User)
            .Include(b => b.Bkg_Property)
            .Where(b => b.BookingStatus != "Closed")
            .Where(b => b.Bkg_User.UserName.Contains(currentUser.UserName))
            .ToListAsync();

    private void CheckBkgRequest()
    {
        // LINQ query to check if all dates in the range are available
        //var result =  Bkg_UserService.Bkg_AvailableAllSync(Fmdate, Todate);

        newBooking = new Bkg_Booking();
        newBooking.DateArrive = Fmdate; 
        newBooking.DateDepart = Todate;
        newBooking.UserId = currentUser.UserId;
        newBooking.PropertyId = currentBooking.PropertyId;
        newBooking.BookingStatus = "Requested";
        newBooking.Bkg_User = currentUser;
        //        newBooking.Bkg_Property = BkgProperties.FirstOrDefault(p => p.PropertyId == rqstPropertyId);
        currentBooking = newBooking;  // maybe ???

        var isAvail =  bkg_Engine.RequestBooking(newBooking);
        if (isAvail)
        {
            modalTitle = "Booking Requested";
            modalMessage = "Your booking request is AVAILABLE. Please press SAVE to confirm or CANEL to quit.";
            allDatesAvailable = true;
        }
        else
        {
            modalTitle = "Booking Request Failed";
            modalMessage = "Sorry but your booking request is not possible.";
            allDatesAvailable = false;
        }
        showModal = true;

    }

    private void EditBooking(Bkg_Booking booking)
    {
        orgnBkg = new();

        orgnBkg.DateArrive = booking.DateArrive;
        orgnBkg.DateDepart = booking.DateDepart;
        orgnBkg.PropertyId = booking.PropertyId;
        currentBooking = booking;
        modalTitle = "Edit Booking";
        modalMessage = "";
        allDatesAvailable = true;
        showModal = true;
    }
    private async Task DeleteBooking(int bookingId)
    {
        var booking = await ApplicationDbContext.bkg_Bookings.FindAsync(bookingId);
        if (booking != null)
        {
            try
            {
                await bkg_Engine.DeleteBookingAsync(booking);
                await LoadBookings();
            }
            catch (Exception ex)
            {
                modalTitle = "Error found deleting this Booking";
                modalMessage = ex.ToString();
                allDatesAvailable = false;
                showModal = true;
            }

            // await LoadBookings();
        }
    }

    private void CloseModal()
    {
        showModal = false;
    }
    private void CloseConfirmModal()
    {
        sendConfirmMsg = false;
    }
    private async Task SaveBooking()
    { 
        currentBooking.Bkg_User = await ApplicationDbContext.bkg_Users.FindAsync(currentBooking.UserId);
        currentBooking.Bkg_Property = await ApplicationDbContext.bkg_Properties.FindAsync(currentBooking.PropertyId);
        // if a new booking then we need to Create it else Change it.
        if(currentBooking.BookingId == 0) // A new booking
        {
            var savedOK = await bkg_Engine.CreateBookingAsync(currentBooking);
            if (!savedOK)
            {
                modalMessage = "Error found saving this new Booking";
                allDatesAvailable = false;
                showModal = true;
            }
            else
            {
                // will send an email confirmation
                SendEmailConfirmation();
            }
        }
        else // editing existing bkg
        {
            var savedOK = await bkg_Engine.EditBookingAsync(orgnBkg, currentBooking);
            if (!savedOK)
            { 
                modalMessage = "Error found saving this edited Booking";
                allDatesAvailable = false;
                showModal = true;
            }
            else
            {
                // will send an email confirmation
                SendEmailConfirmation();
            }

        }

        showModal = false;
        await LoadBookings();
        StateHasChanged();
    }
    private void SendEmailConfirmation(int bookingId)
    {
        currentBooking = bookings.FirstOrDefault(b => b.BookingId == bookingId);
        sendConfirmMsg = true;
    }
    private void SendEmailConfirmation()
    {
        string subjectMsg = string.Concat("BkgRef: ", currentBooking.BookingId.ToString(), " for ", currentBooking.Bkg_Property.Name,
        " from ", currentBooking.DateArrive.Date.ToString("d"), " to ", currentBooking.DateDepart.Date.ToString("d"));
        emailMessage = new EmailMessage(currentBooking.Bkg_User.UserEmail,
            "Booking Confirmation", "", currentBooking.DateArrive, currentBooking.DateDepart, currentUser);

        emailMessage.Subject = subjectMsg; 

        // Using TNZ
        var apiUser = new TNZApiUser()  // this shoild come from configuration injection
            {
                AuthToken = configuration["TNZ:AuthToken"]
            };
        var client = new TNZApiClient(apiUser);

        var reponseEmail = client.Messaging.Email.SendMessage(
            fromEmail: configuration["TNZ:fromEmail"],  // this should come from configuration injection
            emailSubject: subjectMsg,
            messagePlain: emailMessage.ConfirmBkgMsg,
            destination: currentBooking.Bkg_User.UserEmail
        );
        sendConfirmMsg = false;
    }
    private void SendTxtConfirmation()
    {
        string subjectMsg = string.Concat("BkgRef: ", currentBooking.BookingId.ToString(), " for ", currentBooking.Bkg_Property.Name,
        " from ", currentBooking.DateArrive.Date.ToString("d"), " to ", currentBooking.DateDepart.Date.ToString("d"));

        emailMessage = new EmailMessage(currentBooking.Bkg_User.UserEmail,
            "Booking Confirmation", "", currentBooking.DateArrive, currentBooking.DateDepart, currentUser);

        emailMessage.Subject = subjectMsg; 
        string txtrept = emailMessage.Chk_E_164_Phone(currentBooking.Bkg_User.UserPhone);
        // Using TNZ
        var apiUser = new TNZApiUser()  // this shoild come from configuration injection
            {
                AuthToken = configuration["TNZ:AuthToken"]
            };
        var client = new TNZApiClient(apiUser);

        var response = client.Messaging.SMS.SendMessage
            (
                destination: txtrept,                    
                messageText: emailMessage.ConfirmBkgTxtMsg
            );
        sendConfirmMsg = false;
    }
}

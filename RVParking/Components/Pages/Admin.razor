@page "/admin"
@rendermode InteractiveServer
<PageTitle>RV Park Administration</PageTitle>
@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@using RVParking.Data


@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject ApplicationDbContext ApplicationDbContext
@inject Bkg_UserService Bkg_UserService
<h3>RV Park Booking, Data and User Administration</h3>


<div class="tabs">
    <button class="@(activeTab == "Tab1" ? "active" : "")" @onclick="@(() => SetActiveTab("Tab1"))">New Booking</button>
    <button class="@(activeTab == "Tab2" ? "active" : "")" @onclick="@(() => SetActiveTab("Tab2"))">Current Bookings</button>
    <button class="@(activeTab == "Tab3" ? "active" : "")" @onclick="@(() => SetActiveTab("Tab3"))">Past Bookings</button>
    <button class="@(activeTab == "Tab4" ? "active" : "")" @onclick="@(() => SetActiveTab("Tab4"))">New Booking</button>
    <button class="@(activeTab == "Tab5" ? "active" : "")" @onclick="@(() => SetActiveTab("Tab5"))">Property Maintenance</button>
    <button class="@(activeTab == "Tab6" ? "active" : "")" @onclick="@(() => SetActiveTab("Tab6"))">Booking Availability</button>

</div>
<hr />
<div id="Tab1" class="tabcontent" style="@(activeTab == "Tab1" ? "display: block;" : "display: none;")">
    <h4>New Booking for <b>@BkgType</b></h4>
    <div class="form-group" style="display:flex;flex-direction:row;">
        <div class="form-group" style="max-width: 25%; text-align:center; margin-left: 2%">
            <label for="fmdate">Arriving</label>
            <InputDate @bind-Value=Fmdate class="form-control" id="fmdate" />
            @* <ValidationMessage For="() => emailMessage.Fmdate" /> *@
        </div>
        <div class="form-group" style="max-width: 25%; text-align:center; margin-left: 2%;">
            <label for="todate">Departing</label>
            <InputDate @bind-Value=Todate class="form-control" id="todate" />
            @* <ValidationMessage For="() => emailMessage.Todate" /> *@
        </div>
    </div>
    <div>
        <button class="btn btn-primary" style="min-width: 40%; align-content: center;" @onclick="CheckBkgRequest">Request Booking</button>
    </div>
</div>

<div id="Tab2" class="tabcontent" style="@(activeTab == "Tab2" ? "display: block;" : "display: none;")">
    <h3>Existing Bookings</h3>
    <p>Here you can see your existing bookings.</p>
    <p>****** STILL bloody working on it.... a  WORK IN PROGRESS SORRY ******</p>
</div>
<div id="Tab3" class="tabcontent" style="@(activeTab == "Tab3" ? "display: block;" : "display: none;")">
    <h3>Past Bookings</h3>
    <p>Here are the bookings you have had in the past.</p>
    <p>****** W. I. P. ******</p>
</div>
<div id="Tab4" class="tabcontent" style="@(activeTab == "Tab4" ? "display: block;" : "display: none;")">
    <h3>Past Bookings</h3>
    <p>Here are the bookings you have had in the past.</p>
    <p>****** W. I. P. ******</p>
</div>
<div id="Tab5" class="tabcontent" style="@(activeTab == "Tab5" ? "display: block;" : "display: none;")">
    <h3>Property Maintenance</h3>
    <p>Here are the bookings you have had in the past.</p>
    <p>****** W. I. P. ******</p>
</div>
<div id="Tab6" class="tabcontent" style="@(activeTab == "Tab6" ? "display: block;" : "display: none;")">
    <h4>Create Update or Delete Bkg_Availability Records</h4>

    <div class="form-group" style="display:flex;flex-direction:row; margin-bottom: 1%;">
        @*  <div class="form-group" style="max-width: 60%; text-align:center;">
            <label for="bkgType">Select Property</label>
            <select class="form-control" id="bkgType" @bind="BkgType">
                <option style="text-align:center;" value="RVPark On Fitz">RVPark On Fitz</option>
                <option style="text-align:center;" value="Accomodation On Fitz">Accomodation On Fitz</option>
            </select>
        </div> *@
        <div class="form-group" style="max-width: 60%; text-align:center;">
            <label for="bkgType">Select Property</label>
            <select class="form-control" id="bkgType" @bind="BkgType">
                @foreach (var property in BkgProperties)
                {
                    <option value="@property.PropertyId">@property.Name</option>
                }
            </select>

        </div>        


        <div class="form-group" style="text-align:center; max-width: 60%; margin-left: 1%">
            <label for="bkgAvail">Availability</label>
            <select class="form-control"  id="bkgAvail" @bind="isAvail">
                <option style="text-align:center;" value="Yes">Is Available</option>
                <option style="text-align:center;" value="No">Not Available</option>
            </select>
        </div>

        <div class="form-group" style="max-width: 40%; text-align:center; margin-left: 2%;">
            @* <input type="checkbox" @bind="isChecked" /> Check to delete *@
            <label for="bkgAvail">To Delete ?</label>
            <select class="form-control" id="toDelete" style="color:red;" @bind="toDelete">
                <option value="no"></option>
                <option value="YES">*DELETE*</option>
            </select>
        </div>
    </div>
    <div class="form-group" style="display:flex;flex-direction:row; margin-bottom: 1%">
        <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 0%">
            <label for="fmdate">From Date</label>
            <InputDate @bind-Value=Fmdate class="form-control"  id="fmdate" />
            @* <ValidationMessage For="() => emailMessage.Fmdate" /> *@
        </div>
        <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
            <label for="todate">To Date</label>
            <InputDate @bind-Value=Todate class="form-control" id="todate" />
            @* <ValidationMessage For="() => emailMessage.Todate" /> *@
        </div>
        <div class="form-group" style="text-align:center; max-width: 60%; margin-left: 1%">
            <label for="bkgAvailStatus">Status</label>
            <select class="form-control" id="bkgAvailStatus" @bind="status">
                <option style="text-align:center;" value=""></option>
                <option style="text-align:center;" value="NA">Not Available</option>
                <option style="text-align:center;" value="Booked">Booked</option>
                <option style="text-align:center;" value="CLOSED">Closed</option>
            </select>
        </div>
    </div>
    <div>
        <button class="btn btn-primary" style="min-width: 28%; align-content: center;" @onclick="CrudBkBkgAvailablilty">Create Update or Delete Bkg_Availability</button>
    </div>
</div>





@* <div class="card" style="max-width: 500px">
    <div class="card-sm" style="max-width: 500px; text-align: center;">

        <img src="images/RVParkBlkAA.png" alt="https://via.placeholder.com/100" max-width="300px" ; class="card-sm" />
        <br />
        <a href="https://campable.com/locations/5137171604307968" color="white" text-align="center" target="_blank">RVPark On Fitz</a>
        <p>We manage your bookings through this web site where you can see availablity, make and manage your bookings.</p>
        <p>****** STILL A WORK IN PROGRESS SORRY ******</p>
    </div>
</div>
<div class="card" style="max-width: 500px">
    <div class="card-sm" style="max-width: 500px; text-align: center;">
        <br />

        <img src="images/NZMCALogoA.png" alt="https://via.placeholder.com/100" class="card-sm" />
        <p>However if you are a NZMCA Member then please use the <br /> <a href="./ContactUs">"Contact Us"</a> <br />page to arrange your booking with membership discount.</p>
    </div>
</div>
 *@


@code {
    private string activeTab = "Tab6";
    private string BkgType = "RVPark On Fitz";
    private string isAvail = "Yes";
    public DateTime Fmdate { get; set; } = DateTime.Now.Date;

    public DateTime Todate { get; set; } = DateTime.Now.Date;

    private bool allDatesAvailable = false;
    private string toDelete = "no";
    private string status = string.Empty;
    private List<Bkg_Property> BkgProperties = new List<Bkg_Property>();

    protected override async Task OnInitializedAsync()
    {
        BkgProperties = await ApplicationDbContext.bkg_Properties.ToListAsync();
        if (BkgProperties.Any())
        {
            BkgType = BkgProperties.First().PropertyId.ToString();
        }
    }
    private void OnBkgTypeChange(ChangeEventArgs e)
    {
        BkgType = e.Value.ToString();
        // Update other fields based on the selected BkgType
        // For example, you can fetch additional data from the database and update the UI
    }

    private void SetActiveTab(string tabName)
    {
        activeTab = tabName;
    }
    private void CheckBkgRequest()
    {
        // LINQ query to check if all dates in the range are available
        if (ApplicationDbContext.bkg_Availabilities == null)
        {
            allDatesAvailable = false;
        }
        else
        {
            // perhaps we wish to update if the record is there otherwise create it but not duplicate it.
            DateTime dte = Fmdate;
            while (dte <= Todate)
            {
                // var bkgAvailability = new Bkg_Availability(){
                //     DateAvailable = dte,
                //         Available = true,
                //         PropertyId = 1
                // });
                dte = dte.AddDays(1);
            }
            // var res = ApplicationDbContext.bkg_Availabilities.ExecuteUpdateAsync(bkgAvailabilities);
            // var res1 =  ApplicationDbContext.SaveChangesAsync();
        }
    }

    private async Task CrudBkBkgAvailablilty()
    {
        if (toDelete == "YES")
        {
            var recordsToDelete = ApplicationDbContext.bkg_Availabilities
                .Where(a => a.PropertyId == int.Parse(BkgType) && a.DateAvailable >= Fmdate && a.DateAvailable <= Todate);

            ApplicationDbContext.bkg_Availabilities.RemoveRange(recordsToDelete);
        }
        else
        {
            DateTime dte = Fmdate;
            while (dte <= Todate)
            {
                var existingRecord = ApplicationDbContext.bkg_Availabilities
                    .FirstOrDefault(a => a.PropertyId == int.Parse(BkgType) && a.DateAvailable == dte);

                if (existingRecord != null)
                {
                    existingRecord.Available = isAvail == "Yes";
                    existingRecord.AvailabilityStatus = status;
                }
                else
                {
                    var newRecord = new Bkg_Availability
                    {
                        PropertyId = int.Parse(BkgType),
                        DateAvailable = dte,
                        Available = isAvail == "Yes",
                        AvailabilityStatus = status
                    };
                    ApplicationDbContext.bkg_Availabilities.Add(newRecord);
                }
                dte = dte.AddDays(1);
            }
        }
        await ApplicationDbContext.SaveChangesAsync();
    }
}




@page "/availabilityapmt"
@rendermode InteractiveServer
<PageTitle>Apmt Availability</PageTitle>


@using RVParking.Data
@using RVParking.Components.Account
@using System.Globalization
@using Microsoft.AspNetCore.Identity.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using System.Security.Claims

@* @using Syncfusion.Blazor
@using Syncfusion.Blazor.Calendars *@


@* Is Being Used *@

@inject IdentityUserAccessor UserAccessor

@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject ApplicationDbContext ApplicationDbContext

@inject IConfiguration configuration
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IEmailSender<ApplicationUser> EmailSender

<AuthorizeView>
    <Authorized>


<h3 style="color:darkolivegreen;">Apartment Availability - See what dates are available.</h3>
@* <div class="form-group" style="text-align:left; max-width: 30%; min-width: 260px; margin-left: 1%;">
    <label>Property</label>
    <InputSelect select class="form-control" @bind-Value="@propertyID" @onclick="propertyChanged">
        <option value="0">Select RVPark or Apartment</option>
        @foreach (var property in BkgProperties)
        {
            <option value="@property.PropertyId">@property.Name</option>
        }
    </InputSelect>
</div> *@
<div class="calendar-navigation" style="display:flex;flex-direction:row; text-align:center;">
    <div class="form-group" style="text-align:center; margin-left: 1%;">
        <button class="btn btn-primary" @onclick="PreviousMonth">&lt;</button>
    </div>
    <div style="width: 140px; text-align: center;">
       <span class="current-month" >@CurrentMonth.ToString("MMMM yyyy")</span>
    </div>
    <div class="form-group" style="text-align:center; margin-left: 1%;">
        <button class="btn btn-primary" @onclick="NextMonth">&gt;</button>
    </div>
</div>

<div class="calendar-grid">
    <div class="calendar-header">
        @* set for monday start of week, else for Sunday us (var day in culture.DateTimeFormat.AbbreviatedDayNames) below *@
       @foreach (var day in culture.DateTimeFormat.AbbreviatedDayNames.Skip(1).Concat(culture.DateTimeFormat.AbbreviatedDayNames.Take(1)))
       {
           <div class="calendar-day-header">@day</div>
       }
    </div>

    <div class="calendar-body">
        @foreach (var day in calendarDays)
        {
            <div class="calendar-day @day.StatusCss" @onchange="() => ShowDayDetails(day)">
                <div class="date-number">@day.Date.Day</div>
                <div class="day-status">@day.Status</div>
            </div>
        }
    </div>
</div>

@if (showDayDetail)
{
    <div class="day-detail-modal">
        <div class="modal-content">
            <h4>@selectedDay.Date.ToString("D")</h4>
            <select class="form-control" @bind="selectedDay.Status">
                <option value="Available">Available</option>
                <option value="Busy">Busy</option>
                <option value="Unavailable">Unavailable</option>
            </select>
            <button class="btn btn-primary mt-2" @onclick="CloseDetails">Close</button>
        </div>
    </div>
}

    </Authorized>
    <NotAuthorized>
        <h4>- You are NOT AUTHORIZED -</h4>
    </NotAuthorized>
</AuthorizeView>


@code {
    private string BkgType = "RVPark On Fitz";
    private Bkg_Booking currentBooking = new();
    private List<Bkg_Property> BkgProperties = new List<Bkg_Property>();
    private List<Bkg_Availability> availabilities = new List<Bkg_Availability>();

    private DateTime CurrentMonth = DateHelper.GetCurrentDateInNZ();
    private List<DayEntry> calendarDays = new();
    private bool showDayDetail = false;
    private DayEntry selectedDay = new();
    private readonly CultureInfo culture = CultureInfo.CurrentCulture;
    private int propertyID = 2; // should be id of first in loaded properties

    private bool isAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        CurrentMonth = DateHelper.GetCurrentDateInNZ();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isAdmin = user.IsInRole("Admin");


        BkgProperties = await ApplicationDbContext.bkg_Properties.ToListAsync();
        //  await LoadBookings();
        await GenerateCalendar();

    }

    private async Task  GenerateCalendar()
    {
        calendarDays.Clear();
        //if() when select is deselcted the property ID is still the last valus does mot go to 0
        var monthStart = new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1);
        var monthEnd = monthStart.AddMonths(1).AddDays(-1);
        var startDate = monthStart.AddDays(-((int)monthStart.DayOfWeek) + 1);
        if (monthStart.DayOfWeek == DayOfWeek.Sunday) startDate = monthStart.AddDays(-6);
        var endDate = monthEnd.AddDays(7 - (int)monthEnd.DayOfWeek); // 7 for mon start else 6 for Sun
        //var todaydte = DateTime.Now.Date.AddDays(-1); // Show yesterdays status to allow self arrival earlier 
        var todaydte = DateHelper.GetCurrentDateInNZ().Date.AddDays(-1); // Show yesterdays status to allow self arrival earlier

        // If an Admin User then allow display from the first day of the month.
        if(isAdmin)
        {
            todaydte = monthStart;
        }
        //var todaydte = DateTime.Now.Date;
        availabilities = new List<Bkg_Availability>();
        await GetAvailability(monthStart, monthEnd);
        if (propertyID > 0)
        {
            for (var date = startDate; date <= endDate; date = date.AddDays(1))
            {
                var availability = availabilities.FirstOrDefault(a => a.DateAvailable.Date == date.Date);
                string daystatus;
                if (availability == null)
                {
                    daystatus = "N/A";
                }
                else if (availability.Available)
                {
                    daystatus = "Available";
                }
                else
                {
                    daystatus = "Booked";
                }
                if (date.Month != CurrentMonth.Month) daystatus = ""; 
                if (date < todaydte) daystatus = "";
                calendarDays.Add(new DayEntry
                {
                    Date = date,
                    Status = daystatus,
                    StatusCss = GetStatusCss(daystatus, date)
                });
            }
        }
        StateHasChanged();
    }
    private  async Task GetAvailability(DateTime dteStart, DateTime dteEnd)
    {
        var query = ApplicationDbContext.bkg_Availabilities
               .Include(a => a.Bkg_Property)
               .AsQueryable();

        if (currentBooking.PropertyId!=null)
        {
            query = query.Where(a => a.Bkg_PropertyId == propertyID);
        }

        if (dteStart != null)
        {
            query = query.Where(a => a.DateAvailable >= dteStart);
        }

        if (dteEnd != null)
        {
            query = query.Where(a => a.DateAvailable <= dteEnd);
        }

        // if (!string.IsNullOrEmpty(searchStatus))
        // {
        //     query = query.Where(a => a.AvailabilityStatus == searchStatus);
        // }

        // if (!string.IsNullOrEmpty(searchIsAvail))
        // {
        //     bool isAvailable = searchIsAvail == "Yes";
        //     query = query.Where(a => a.Available == isAvailable);
        // }
        try{
            
                availabilities = await query.AsNoTracking().ToListAsync();
        }
            catch (Exception ex)
        {
           // Console.WriteLine($"Error ordering availability: {ex.Message}");
        }
        //availabilities = await query.AsNoTracking().ToListAsync();   // Simulate getting availability status
        // return GetRandomStatus();
    }
    private string GetStatusCss(DateTime date)
    {
        if (date.Month != CurrentMonth.Month) return "other-month";
        return selectedDay.Status switch
        {
            "Available" => "status-available",
            "Booked" => "status-busy",
            "Unavailable" => "status-unavailable",
            _ => ""
        };
    }
    private string GetStatusCss(string daystatus, DateTime date)
    {
        if (date.Month != CurrentMonth.Month) return "other-month";
        // return selectedDay.Status switch
        // {
        //     "Available" => "status-available",
        //     "Busy" => "status-busy",
        //     "NOT Available" => "status-unavailable",
        //     _ => ""
        // };
        return daystatus switch
        {
            "Available" => "status-available",
            "Booked" => "status-busy",
            "N/A" => "status-unavailable",
            _ => ""
        };
    }

    private string GetRandomStatus()
    {
        var statuses = new[] { "Available", "Busy", "Unavailable" };
        return statuses[new Random().Next(statuses.Length)];
    }
    private async Task propertyChanged()
    {
         await GenerateCalendar();
    }
    private async Task PreviousMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        await GenerateCalendar();
    }

    private async Task NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        await GenerateCalendar();
    }

    private async Task ShowDayDetails(DayEntry day)
    {
        // selectedDay = day;
        // showDayDetail = true;
    }

    private async Task CloseDetails()
    {
        // showDayDetail = false;
        // GenerateCalendar(); // Refresh calendar after changes
    }

    public class DayEntry
    {
        public DateTime Date { get; set; }
        public string Status { get; set; } = "Available";
        public string StatusCss { get; set; } = "";
    }
}

<style>
    .calendar-navigation {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .calendar-grid {
        display: grid;
        grid-template-rows: auto 1fr;
        border: 1px solid #ddd;
    }

    .calendar-header, .calendar-body {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #ddd;
    }

    .calendar-day-header {
        padding: 10px;
        text-align: center;
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .calendar-day {
        min-height: 40px;
        padding: 5px;
        background-color: white;
        position: relative;
        cursor: pointer;
    }

    .other-month {
        background-color: #f8f9fa;
        color: #6c757d;
    }

    .date-number {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .day-status {
        font-size: 0.8em;
    }

    .status-available {
        background-color: #d4edda;
    }

    .status-busy {
        background-color: #fff3cd;
    }

    .status-unavailable {
        background-color: coral;
    }

    .day-detail-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        min-width: 300px;
    }
</style>

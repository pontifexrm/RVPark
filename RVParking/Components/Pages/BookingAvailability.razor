@page "/bookingavailability"
@rendermode InteractiveServer
<PageTitle>RV Park Administer Bkg Availablility</PageTitle>


@using RVParking.Data
@using RVParking.Components.Account

@using Microsoft.AspNetCore.Identity.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using TNZAPI.NET;
@using TNZAPI.NET.Core;
@using TNZAPI.NET.Api.Addressbook.Contact.Dto;

@* Is Being Used *@

@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor

@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject ApplicationDbContext ApplicationDbContext
@inject IServiceProvider ServiceProvider
@inject IConfiguration configuration

<AuthorizeView>
    <Authorized>
        <h4>Create Update or Delete Bkg_Availability Records</h4>
        <div class="search-bar">
            <div class="form-group" style="display:flex;flex-direction:row; margin-bottom: 1%;">
                <div class="form-group" style="max-width: 60%; text-align:center;">
                    <label for="bkgType">Select Property</label>
                    <select class="form-control" id="bkgType" @bind="searchPropertyId">
                        <option value="">All Properties</option>
                        @foreach (var property in BkgPropertiesAvail)
                        {
                            <option value="@property.PropertyId">@property.Name</option>
                        }
                    </select>
                </div>
                <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
                    <label for="fmdate">From Date</label>
                    <InputDate @bind-Value="searchFromDate" class="form-control" id="fmdate" Format="dd/MM/yyyy" Locale="en-NZ" />
                </div>
                <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
                    <label for="todate">To Date</label>
                    <InputDate @bind-Value="searchToDate" class="form-control" id="todate" Format="dd/MM/yyyy" Locale="en-NZ" />
                </div>
                <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
                    <label for="availStatus">Availability Status</label>
                    <select class="form-control" id="availStatus" @bind="searchStatus">
                        <option value="">All Statuses</option>
                        <option value="NA">Not Available</option>
                        <option value="Booked">Booked</option>
                        <option value="CLOSED">Closed</option>
                        <option value="Family Here"</option>
                    </select>
                </div>
                <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
                    <label for="isAvail">Availability</label>
                    <select class="form-control" id="isAvail" @bind="searchIsAvail">
                        <option value="">All</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <button class="bi form-control" style="margin-top: 28px; width: 40px; height: 32px; margin-left: 4px;"
                        @onclick="ClearSearchAvailability">
                    <i class="bi bi-x-lg"></i>
                </button>
                <button class="bi form-control" style="margin-top: 28px; width: 40px; height: 32px; margin-left: 4px;"
                        @onclick="SearchAvailability">
                    <i class="bi bi-search"></i>
                </button>
                @*         <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 1%;">
            <button class="btn btn-primary" @onclick="SearchAvailability">Search</button>
        </div> *@
            </div>
        </div>

        <div class="tab-content" style="border: 1px solid #929292; max-width: 60%; display: flex; justify-content: space-between; align-items: center;">
            @* Title and Blkchange button *@
            <h5 style="margin-left: 10px;"> Bulk Change Booking Availability Records>> </h5>
            <div style="display:flex;flex-direction:row; margin-bottom: 2%;">
                <button class="bi form-control" style="width: 40px; height: 32px;" @onclick="OpenBlkChngModal"><i class="bi bi-door-open"></i></button>
                <button class="bi form-control" style="width: 40px; height: 32px;" @onclick="CloseBlkChngModal"><i class="bi bi-door-closed"></i></button>
            </div>
        </div>

        @if (isBlkChngModalOpen)
        {
            @if (BkgPropertiesAvail == null || BkgPropertiesAvail.Count == 0)
            {
                <p>Loading...</p>
            }
            else
            {
                <div class="form-group" style="border: 1px solid #929292; max-width: 60%;">
                    <div class="form-group" style=" max-width: 80%; display:flex;flex-direction:row; margin-bottom: 1%;">
                        <div class="form-group" style="text-align:center; margin-left: 2%;">
                            <label for="bkgType">Select Property</label>
                            <select class="form-control" id="bkgType" @bind="BkgType" stype="margin-left: 10px;">
                                @foreach (var property in BkgPropertiesAvail)
                                {
                                    <option value="@property.PropertyId">@property.Name</option>
                                }
                            </select>

                        </div>


                        <div class="form-group" style="text-align:center; max-width: 60%; margin-left: 2%">
                            <label for="bkgAvail">Availability</label>
                            <select class="form-control" id="bkgAvail" @bind="isAvail" style="margin-left: 2px;">
                                <option style="text-align:center;" value="Yes">Is Available</option>
                                <option style="text-align:center;" value="No">Not Available</option>
                            </select>
                        </div>

                        <div class="form-group" style="max-width: 40%; text-align:center; margin-left: 2%;">
                            @* <input type="checkbox" @bind="isChecked" /> Check to delete *@
                            <label for="bkgAvail">To Delete ?</label>
                            <select class="form-control" id="toDelete" style="color:red;" @bind="toDelete">
                                <option value="no"></option>
                                <option value="YES">*DELETE*</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="display:flex;flex-direction:row; margin-bottom: 1%">
                        <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 2%">
                            <label for="fmdate">From Date</label>
                            <SfDatePicker class="form-group" TValue="DateTime?" Value="@Fmdate" Placeholder='Choose a Date' ID="fmdate">
                                <DatePickerEvents TValue="DateTime?" ValueChange="DteFmChnge"></DatePickerEvents>

                            </SfDatePicker>
                            @*                     <InputDate @bind-Value=Fmdate class="form-control" id="fmdate" style="margin-left: 2px;" />
 *@                    @* <ValidationMessage For="() => emailMessage.Fmdate" /> *@         
                        </div>
                        <div class="form-group" style="max-width: 30%; text-align:center; margin-left: 2%;">
                            <label for="todate">To Date</label>
                            <SfDatePicker class="form-control" TValue="DateTime?" Value="@Todate" Placeholder='Choose a Date' ID="todate">
                                <DatePickerEvents TValue="DateTime?" ValueChange="DteToChnge"></DatePickerEvents>

                            </SfDatePicker>
                            @* <ValidationMessage For="() => emailMessage.Todate" />  *@
                        </div>
                        <div class="form-group" style="text-align:center; max-width: 60%; margin-left: 1%">
                            <label for="bkgAvailStatus">Status</label>
                            <select class="form-control" id="bkgAvailStatus" @bind="status">
                                <option style="text-align:center;" value=""></option>
                                <option style="text-align:center;" value="NA">Not Available</option>
                                <option style="text-align:center;" value="Booked">Booked</option>
                                <option style="text-align:center;" value="CLOSED">Closed</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-primary" style="min-width: 28%; margin-left: 10%; align-content: center;" @onclick="CrudBkBkgAvailablilty">Create Update or Delete Bkg_Availability</button>
                    </div>
                </div>
            }
        }

        @if (availabilities == null)  // Availability table
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table" style="max-width: 60%;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #929292;">Date</th>
                            <th style="border: 1px solid #929292;">Property Name</th>
                            <th style="border: 1px solid #929292;">Availability</th>
                            <th style="border: 1px solid #929292;">Availability Status</th>
                            <th style="border: 1px solid #929292;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var availability in availabilities)
                        {
                            <tr>
                                <td style="border: 1px solid #929292;">@availability.DateAvailable.ToShortDateString()</td>
                                <td style="border: 1px solid #929292;">@availability.Bkg_Property?.Name</td>
                                <td style="border: 1px solid #929292;">@(availability.Available ? "Y" : "N")</td>
                                <td style="border: 1px solid #929292;">@availability.AvailabilityStatus</td>
                                <td style="border: 1px solid #929292;">
                                    <div class="tab-content" style="display:flex;flex-direction:row;">
                                        <button class="bi form-control" style="width: 40px; height: 32px;"
                                                @onclick="() => EditBkgAvailablilty(availability)">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <button class="bi form-control" style="width: 40px; height: 32px;"
                                                @onclick="() => DeleteBkgAvailability(availability)">
                                            <i class="bi bi-trash3" style="block-size:max-content;"></i>
                                        </button>
                                    </div>
                                </td>

                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

    </Authorized>
    <NotAuthorized>
        <h4>- You are NOT AUTHORIZED -</h4>
    </NotAuthorized>
</AuthorizeView>

@if (isEditing)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Availability</h5>
                    <button type="button" class="btn-close" @onclick="CancelEdit"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="currbkg_Availability" OnValidSubmit="SaveAvailability">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="form-group">
                            <label for="property">Property</label>
                            <InputSelect id="property" @bind-Value="currbkg_Availability.Bkg_PropertyId" class="form-control">
                                @foreach (var property in BkgPropertiesAvail)
                                {
                                    <option value="@property.PropertyId">@property.Name</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group">
                            <label for="dateAvailable">Date Available</label>
                            @* <SfDatePicker class="form-group" TValue="DateTime?" Value="@currbkg_Availability.DateAvailable" Placeholder='Choose a Date' ID="dateAvailable"> </SfDatePicker> *@

                            <InputDate id="dateAvailable" @bind-Value="currbkg_Availability.DateAvailable" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="available">Available</label>
                            <InputSelect id="available" @bind-Value="currbkg_Availability.Available" class="form-control">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </InputSelect>
                        </div>
                        <div class="form-group">
                            <label for="availabilityStatus">Availability Status</label>
                            <InputText id="availabilityStatus" @bind-Value="currbkg_Availability.AvailabilityStatus" class="form-control" />
                        </div>

                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}






@code {
    private string BkgType = "RVPark On Fitz";
    private string isAvail = "Yes";
    // public DateTime Fmdate { get; set; } = DateTime.Now.Date;
    // public DateTime Todate { get; set; } = DateTime.Now.Date;
    public DateTime? Fmdate;
    public DateTime? Todate;
    private bool allDatesAvailable = false;
    private string toDelete = "no";
    private string status = string.Empty;
    private ApplicationDbContext _dbContext;

    private List<Bkg_Property> BkgPropertiesAvail = new List<Bkg_Property>();
    private List<Bkg_Availability> availabilities = new List<Bkg_Availability>();

    private int? searchPropertyId;
    private DateTime? searchFromDate;
    private DateTime? searchToDate;
    private string searchStatus = string.Empty;
    private string searchIsAvail = string.Empty;

    private bool isBlkChngModalOpen = false;
    private string modalBlkChngTitle = string.Empty;
    private string modalMessage = string.Empty;

    private bool isEditing = false;
    private bool isNew = false;
    private Bkg_Availability? currbkg_Availability = new Bkg_Availability();

    private bool _isDataLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        if (!_isDataLoaded)
        {
            DbSet<Bkg_Property> bkg_Properties = ApplicationDbContext.bkg_Properties;
            BkgPropertiesAvail = await bkg_Properties.AsNoTracking().ToListAsync();
            BkgType = "1";
            await LoadAvailabilities();
            _isDataLoaded = true;
        }
    }
    // protected override async Task OnParametersSetAsync()
    // {
    //     if ( RefreshChildAvailCallback.HasDelegate)
    //     {
    //         //await RefreshChildAvailCallback.InvokeAsync();
    //         await LoadAvailabilities();
    //     }
    // }
    private async Task LoadAvailabilities()
    {
        var query = ApplicationDbContext.bkg_Availabilities
            .Include(a => a.Bkg_Property)
            .AsQueryable();

        if (searchPropertyId.HasValue)
        {
            query = query.Where(a => a.Bkg_PropertyId == searchPropertyId.Value);
        }

        if (searchFromDate.HasValue)
        {
            query = query.Where(a => a.DateAvailable >= searchFromDate.Value);
        }

        if (searchToDate.HasValue)
        {
            query = query.Where(a => a.DateAvailable <= searchToDate.Value);
        }

        if (!string.IsNullOrEmpty(searchStatus))
        {
            query = query.Where(a => a.AvailabilityStatus == searchStatus);
        }

        if (!string.IsNullOrEmpty(searchIsAvail))
        {
            bool isAvailable = searchIsAvail == "Yes";
            query = query.Where(a => a.Available == isAvailable);
        }
        query = query.OrderBy(a => a.DateAvailable);
        availabilities = await query.AsNoTracking().ToListAsync();
        StateHasChanged();
    }

    private async Task SearchAvailability()
    {
        await LoadAvailabilities();
    }

    private void OnBkgTypeChange(ChangeEventArgs e)
    {
        BkgType = e.Value.ToString();
        // Update other fields based on the selected BkgType
        // For example, you can fetch additional data from the database and update the UI
    }
    private async Task CrudBkBkgAvailablilty()
    {
        if (toDelete == "YES")
        {
            DbSet<Bkg_Availability>? bkg_Availabilities = ApplicationDbContext.bkg_Availabilities;
            var recordsToDelete = bkg_Availabilities
            .Where(a => a.Bkg_PropertyId == int.Parse(BkgType) && a.DateAvailable >= Fmdate && a.DateAvailable <= Todate);

            bkg_Availabilities.RemoveRange(recordsToDelete);
        }
        else
        {
            DateTime? dte = Fmdate != null ? Fmdate : DateTime.Now.Date;
            DateTime? dteTo = Todate != null ? Todate : DateTime.Now.Date;
            while (dte <= dteTo)
            {
                DbSet<Bkg_Availability> bkg_Availabilities = ApplicationDbContext.bkg_Availabilities;
                var existingRecord = bkg_Availabilities
                .FirstOrDefault(a => a.Bkg_PropertyId == int.Parse(BkgType) && a.DateAvailable == dte);

                if (existingRecord != null)
                {
                    existingRecord.Available = isAvail == "Yes";
                    existingRecord.AvailabilityStatus = status;
                }
                else
                {
                    if (dte != null)
                    {
                        var newRecord = new Bkg_Availability
                            {
                                Bkg_PropertyId = int.Parse(BkgType),
                                DateAvailable = (DateTime)dte,
                                Available = isAvail == "Yes",
                                AvailabilityStatus = status
                            };
                        DbSet<Bkg_Availability> bkg_Availabilities1 = ApplicationDbContext.bkg_Availabilities;
                        bkg_Availabilities1.Add(newRecord);
                    }
                }
                dte = dte?.AddDays(1);
            }
        }
        await ApplicationDbContext.SaveChangesAsync();
    }

    private void EditBkgAvailablilty(Bkg_Availability availability)
    {
        // Implement the logic to edit the availability record
        currbkg_Availability = availability;
        isEditing = true;
        isNew = false;
    }
    private void CancelEdit()
    {
        currbkg_Availability = null;
        isEditing = false;
    }
    private async Task DeleteBkgAvailability(Bkg_Availability availability)
    {
        // Create a new instance to avoid tracking issues
        currbkg_Availability = new Bkg_Availability
        {
            AvailabilityId = availability.AvailabilityId,
            Bkg_PropertyId = availability.Bkg_PropertyId,
            DateAvailable = availability.DateAvailable,
            Available = availability.Available,
            AvailabilityStatus = availability.AvailabilityStatus,
            // Copy other properties as needed
        };
        // Use the injected ServiceProvider to create a scope
        using var scope = ServiceProvider.GetRequiredService<IServiceScopeFactory>().CreateScope();
        var freshDbContext = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
        if (currbkg_Availability != null)
        {   // Make sure navigation property is null to avoid tracking issues  
            currbkg_Availability.Bkg_Property = null;
            // Attach and mark as deleted to avoid tracking issues  
            freshDbContext.Attach(currbkg_Availability);
            freshDbContext.Entry(currbkg_Availability).State = EntityState.Deleted;
        }
        await freshDbContext.SaveChangesAsync();

        // // Implement the logic to delete the availability record
        // ApplicationDbContext.bkg_Availabilities?.Remove(availability);
        // await ApplicationDbContext.SaveChangesAsync();
        await LoadAvailabilities();
    }
    private async Task ClearSearchAvailability()
    {
        searchPropertyId = null;
        searchFromDate = null;
        searchToDate = null;
        searchStatus = string.Empty;
        searchIsAvail = string.Empty;
        await SearchAvailability();
    }
    private void OpenBlkChngModal()
    {
        isBlkChngModalOpen = true;
        // Implement the logic to open the bulk change modal
    }
    private void CloseBlkChngModal()
    {
        // Implement the logic to close the bulk change modal
        isBlkChngModalOpen = false;
    }

    // edit and delete availability records form table
    private void EditAvailability(Bkg_Availability availability)
    {
        // Create a new instance to avoid tracking issues
        currbkg_Availability = new Bkg_Availability
        {
            AvailabilityId = availability.AvailabilityId,
            Bkg_PropertyId = availability.Bkg_PropertyId,
            DateAvailable = availability.DateAvailable,
            Available = availability.Available,
            AvailabilityStatus = availability.AvailabilityStatus,
            // Copy other properties as needed
        };
        isEditing = true;
        isNew = false;
    }

    private async Task SaveAvailability()
    {
        // Use the injected ServiceProvider to create a scope
        using var scope = ServiceProvider.GetRequiredService<IServiceScopeFactory>().CreateScope();
        var freshDbContext = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
        if (currbkg_Availability != null)
        {
            // Make sure navigation property is null to avoid tracking issues  
            currbkg_Availability.Bkg_Property = null;
            if (isNew)
            {
                freshDbContext.bkg_Availabilities?.Add(currbkg_Availability);
            }
            else
            {
                // Attach and mark as modified to avoid tracking issues  
                freshDbContext.Attach(currbkg_Availability);
                freshDbContext.Entry(currbkg_Availability).State = EntityState.Modified;
            }
            await freshDbContext.SaveChangesAsync();
            await LoadAvailabilities();
            isEditing = false;
        }
    }
  



    // private async Task DeleteEditAvailability(Bkg_Availability currbkg_Availability)
    // {
    //     ApplicationDbContext.bkg_Availabilities?.Remove(currbkg_Availability);
    //     await ApplicationDbContext.SaveChangesAsync();
    //     LoadAvailabilities();
    // }

    private void DteFmChnge(Syncfusion.Blazor.Calendars.ChangedEventArgs<DateTime?> args)
    {
        Fmdate = args.Value ?? DateTime.Now.Date;
        if (Todate <= Fmdate)
        {
            //     Todate = AddOneDay(Fmdate);
            //     currentBooking.DateArrive = Fmdate;
            //     currentBooking.DateDepart = Todate;
            StateHasChanged();
        }
    }
    private void DteToChnge(Syncfusion.Blazor.Calendars.ChangedEventArgs<DateTime?> args)
    {
        Todate = args.Value ?? DateTime.Now.Date;
        if (Todate <= Fmdate)
        {

            // Fmdate = SubOneDay(Todate);
            // currentBooking.DateArrive = Fmdate;
            // currentBooking.DateDepart = Todate;

            StateHasChanged();
        }
    }


}
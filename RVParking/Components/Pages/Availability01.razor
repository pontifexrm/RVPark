@page "/availability02"
@rendermode InteractiveServer
<PageTitle>RV Park Availability</PageTitle>


@using RVParking.Data
@using RVParking.Components.Account
@using System.Globalization
@using Microsoft.AspNetCore.Identity.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using TNZAPI.NET;
@using TNZAPI.NET.Core;
@using TNZAPI.NET.Api.Addressbook.Contact.Dto;

@* @using Syncfusion.Blazor
@using Syncfusion.Blazor.Calendars *@


@* Is Being Used *@

@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor

@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject ApplicationDbContext ApplicationDbContext

@inject IConfiguration configuration



<h3 style="color:darkolivegreen;">Availability - See what dates are available.</h3>
<div class="form-group" style="text-align:left; max-width: 30%; margin-left: 1%;">
    <label>Property</label>
    <InputSelect select class="form-control" @bind-Value="@currentBooking.PropertyId">
        <option value="">Select Property</option>
        @foreach (var property in BkgProperties)
        {
            <option value="@property.PropertyId">@property.Name</option>
        }
    </InputSelect>
</div>
<div class="calendar-navigation">
    <button class="btn btn-primary" @onclick="PreviousMonth">&lt;</button>
    <span class="current-month">@CurrentMonth.ToString("MMMM yyyy")</span>
    <button class="btn btn-primary" @onclick="NextMonth">&gt;</button>
</div>
<div class="calendar-grid">
    <div class="calendar-header">
        @foreach (var day in culture.DateTimeFormat.AbbreviatedDayNames)
        {
            <div class="calendar-day-header">@day</div>
        }
    </div>
    <div class="calendar-body">
        @foreach (var day in calendarDays)
        {
            <div class="calendar-day @day.StatusCss" @onclick="() => ShowDayDetails(day)">
                <div class="date-number">@day.Date.Day</div>
                <div class="day-status">@day.Status</div>
            </div>
        }
    </div>

</div>


<style>
    .calendar-navigation {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .calendar-grid {
        display: grid;
        grid-template-rows: auto 1fr;
        border: 1px solid #ddd;
    }

    .calendar-header, .calendar-body {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #ddd;
    }

    .calendar-day-header {
        padding: 10px;
        text-align: center;
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .calendar-day {
        min-height: 100px;
        padding: 5px;
        background-color: white;
        position: relative;
        cursor: pointer;
    }

    .other-month {
        background-color: #f8f9fa;
        color: #6c757d;
    }

    .date-number {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .day-status {
        font-size: 0.8em;
    }

    .status-available {
        background-color: #d4edda;
    }

    .status-busy {
        background-color: #fff3cd;
    }

    .status-unavailable {
        background-color: #f8d7da;
    }

    .day-detail-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        min-width: 300px;
    }
</style>


@code {
    private string BkgType = "RVPark On Fitz";
    private Bkg_Booking currentBooking = new();
    private List<Bkg_Property> BkgProperties = new List<Bkg_Property>();
   
    private DateTime CurrentMonth = DateTime.Today;
    private List<DayEntry> calendarDays = new();
    private bool showDayDetail = false;
    private DayEntry selectedDay = new();
    private readonly CultureInfo culture = CultureInfo.CurrentCulture;

    public class DayEntry
    {
        public DateTime Date { get; set; }
        public string Status { get; set; } = "Available";
        public string StatusCss { get; set; } = "";
    }

    
    protected override async Task OnInitializedAsync()
    {
        CurrentMonth = DateHelper.GetCurrentDateInNZ();
        BkgProperties = await ApplicationDbContext.bkg_Properties.ToListAsync();
        //  await LoadBookings();
        GenerateCalendar();

    }
    private void GenerateCalendar()
    {
        calendarDays.Clear();

        var monthStart = new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1);
        var monthEnd = monthStart.AddMonths(1).AddDays(-1);
        var startDate = monthStart.AddDays(-(int)monthStart.DayOfWeek);
        var endDate = monthEnd.AddDays(6 - (int)monthEnd.DayOfWeek);

        for (var date = startDate; date <= endDate; date = date.AddDays(1))
        {
            calendarDays.Add(new DayEntry
                {
                    Date = date,
                    Status = GetRandomStatus(),
                    StatusCss = GetStatusCss(date)
                });
        }
    }

    private string GetStatusCss(DateTime date)
    {
        if (date.Month != CurrentMonth.Month) return "other-month";
        return selectedDay.Status switch
        {
            "Available" => "status-available",
            "Busy" => "status-busy",
            "Unavailable" => "status-unavailable",
            _ => ""
        };
    }

    private string GetRandomStatus()
    {
        var statuses = new[] { "Available", "Busy", "Unavailable" };
        return statuses[new Random().Next(statuses.Length)];
    }

    private void PreviousMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        GenerateCalendar();
    }

    private void NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        GenerateCalendar();
    }

    private void ShowDayDetails(DayEntry day)
    {
        selectedDay = day;
        showDayDetail = true;
    }

    private void CloseDetails()
    {
        showDayDetail = false;
        GenerateCalendar(); // Refresh calendar after changes
    }

}

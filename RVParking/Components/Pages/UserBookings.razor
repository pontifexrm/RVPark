@page "/user-bookings"
@rendermode InteractiveServer

@using RVParking.Data
@using Microsoft.EntityFrameworkCore
@using RVParking.Components.Account

@using Microsoft.AspNetCore.Identity.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using TNZAPI.NET;
@using TNZAPI.NET.Core;
@using TNZAPI.NET.Api.Addressbook.Contact.Dto;

@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor

@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject ApplicationDbContext ApplicationDbContext

@inject IConfiguration configuration

<h3>Users and Their Bookings</h3>

@if (users == null || users.Count == 0)
{
    <p><em>Loading users...</em></p>
}
else
{
    <div class="row">
        <!-- Master Section: List of Users -->
        <div class="col-md-3">
            <h4>Users</h4>
            <ul class="list-group">
                @foreach (var user in users)
                {
                    <div class="list-group-item" style="width:100%;" @onclick="() => SelectUser(user)">
                            @user.UserFirstName @user.UserLastName @user.UserName
                    </div>
                }
            </ul>
        </div>

        <!-- Detail Section: Bookings for Selected User -->
        <div class="col-md-8">
            @if (selectedUser == null)
            {
                <p>Select a user to view their bookings.</p>
            }
            else
            {
                <h4>Bookings for @selectedUser.UserName</h4>
                @if (bookings == null || bookings.Count == 0)
                {
                    <p><em>No bookings found for this user.</em></p>
                }
                else
                {
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Arrival</th>
                                <th>Departure</th>
                                <th>Status</th>
                                <th>Comments</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var booking in bookings)
                            {
                                <tr>
                                    <td>@booking.Bkg_Property.Name</td>
                                    <td>@booking.DateArrive.ToShortDateString()</td>
                                    <td>@booking.DateDepart.ToShortDateString()</td>
                                    <td>@booking.BookingStatus</td>
                                    <td>@booking.BookingComments</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            }
        </div>
    </div>
}

@code {
    private List<Bkg_User> users = new();
    private Bkg_User? selectedUser;
    private List<Bkg_Booking> bookings = new();

    protected override async Task OnInitializedAsync()
    {
        // Load all users
        users = await ApplicationDbContext.bkg_Users.ToListAsync();
    }

    private async Task SelectUser(Bkg_User user)
    {
        selectedUser = user;

        // Load bookings for the selected user
        bookings = await ApplicationDbContext.bkg_Bookings
            .Include(b => b.Bkg_Property)
            .Where(b => b.UserId == user.UserId)
            .ToListAsync();
    }
}

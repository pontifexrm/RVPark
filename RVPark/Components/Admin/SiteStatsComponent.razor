@page "/sitestats"
@rendermode InteractiveServer

@using RVPark.Data
@using RVPark.Services
@using Microsoft.EntityFrameworkCore
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Grids
@using Microsoft.AspNetCore.Components.QuickGrid


@* @inject DataTransferService TransferService *@
@inject ApplicationDbContext dbContext
<h3>Site Statistics</h3>
<AuthorizeView Roles="Admin" Context="authContext">
    <NotAuthorized>
        <div class="tab-content" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h4>- You are NOT AUTHORIZED -</h4>
            </div>
        </div>
    </NotAuthorized>
    <Authorized>

<h3>Retreive Log data from RVPark and Display Stats</h3>
<p>
    This page allows you to manually trigger the transfer of log data from the RVPark.nz website to the local database,
    and view statistics on login attempts and visit logs.
</p>
<div class="mb-3">
    <label for="filterInput">Exclude UserNames/IPs (separate with |):</label>
    <input type="text" id="filterInput" class="form-control" @bind="filterString" placeholder="user1|192.168.1.1|user2" />
</div>
<button type="button" class="btn btn-secondary" @onclick="GetLoginStats"> Refresh and Show Statistics </button>
<br />
<br />
    <SfAccordion  Width="98%" ExpandMode="ExpandMode.Single">
        <Syncfusion.Blazor.Navigations.AccordionItems>
            <Syncfusion.Blazor.Navigations.AccordionItem >
                <HeaderTemplate>
                        <h4 class="card-title">Login Statistics</h4>
                </HeaderTemplate>
                <ContentTemplate>
                        @if (loginStats != null)
                        {
                            <div style="overflow-x:auto;">
                                <QuickGrid Items="@GetLoginStatsAsQueryable()" Class="table">
                                    <PropertyColumn Property="@(s => s.TimePeriod)" Title="Time Period" />
                                    <PropertyColumn Property="@(s => s.SuccessfulLogins)" Title="Successful Logins" />
                                    <PropertyColumn Property="@(s => s.FailedLogins)" Title="Failed Logins" />
                                    <PropertyColumn Property="@(s => s.TotalLogins)" Title="TOTAL Logins" />
                                </QuickGrid>
                                <Paginator State="@loginStatsPagination" />
                            </div>
                        }
                </ContentTemplate>
            </Syncfusion.Blazor.Navigations.AccordionItem>
                <Syncfusion.Blazor.Navigations.AccordionItem>
                    <HeaderTemplate>
                        <h4 class="card-title">Pages Visited Statistics</h4>
                    </HeaderTemplate>
                    <ContentTemplate>
                        @if (visitStats != null)
                        {
                            <div style="overflow-x:auto;">
                                <QuickGrid Items="@visitStats.AsQueryable()" Pagination="@visitStatsPagination" Class="table">
                                    <PropertyColumn Property="@(v => v.Location)" Title="Location" Sortable="true" />
                                    <PropertyColumn Property="@(v => v.Count24h)" Title="Count24h" Sortable="true" />
                                    <PropertyColumn Property="@(v => v.UniqueUsers24h)" Title="Unique24h" Sortable="true" />
                                    <PropertyColumn Property="@(v => v.CountWeek)" Title="CountWeek" Sortable="true" />
                                    <PropertyColumn Property="@(v => v.UniqueUsersWeek)" Title="UniqueWeek" Sortable="true" />
                                    <PropertyColumn Property="@(v => v.CountMonth)" Title="CountMonth" Sortable="true" />
                                    <PropertyColumn Property="@(v => v.UniqueUsersMonth)" Title="UniqueMonth" Sortable="true" />
                                    <PropertyColumn Property="@(v => v.CountYear)" Title="CountYear" Sortable="true" />
                                    <PropertyColumn Property="@(v => v.UniqueUsersYear)" Title="UniqueYear" Sortable="true" />
                                </QuickGrid>
                                <Paginator State="@visitStatsPagination" />
                            </div>
                        }
                    </ContentTemplate>
                </Syncfusion.Blazor.Navigations.AccordionItem>
                <Syncfusion.Blazor.Navigations.AccordionItem>
                    <HeaderTemplate>
                        <h4 class="card-title">User Visit Statistics</h4>
                    </HeaderTemplate>
                    <ContentTemplate>
                        @if (userVisitStats != null)
                        {
                            <div style="overflow-x:auto;">
                                <QuickGrid Items="@userVisitStats.AsQueryable()" Pagination="@userVisitPagination" Class="table">
                                    <PropertyColumn Property="@(u => u.UserNameIpAddr)" Title="User Name" Sortable="true" />
                                    <PropertyColumn Property="@(u => u.Location)" Title="Location" Sortable="true" />
                                    <PropertyColumn Property="@(u => u.Count24h)" Title="Count24h" Sortable="true" />
                                    <PropertyColumn Property="@(u => u.CountWeek)" Title="CountWeek" Sortable="true" />
                                    <PropertyColumn Property="@(u => u.CountMonth)" Title="CountMonth" Sortable="true" />
                                    <PropertyColumn Property="@(u => u.CountYear)" Title="CountYear" Sortable="true" />
                                </QuickGrid>
                                <Paginator State="@userVisitPagination" />
                            </div>
                        }
                    </ContentTemplate>
                </Syncfusion.Blazor.Navigations.AccordionItem>
                <Syncfusion.Blazor.Navigations.AccordionItem >
                    <HeaderTemplate>
                        <h4>AppLog (Application Logger) Viewer</h4>
                    </HeaderTemplate>
                    <ContentTemplate>
                        @if (filteredAppLogs != null && filteredAppLogs.Any())
                        {
                            <div style="overflow-x:auto;">
                                <QuickGrid Items="@filteredAppLogs.AsQueryable()" Pagination="@pagination" Class="applog-grid" style="overflow-x: auto;">
                                    <PropertyColumn Property="@(log => log.AppLogId)" Title="ID" Sortable="true" />
                                    <PropertyColumn Property="@(log => log.CreatedAtNZST)" Title="Created At (NZST)" Sortable="true" />
                                    <PropertyColumn Property="@(log => log.LogLevel)" Title="Level" Sortable="true" />
                                    <PropertyColumn Property="@(log => log.Category)" Title="Category" Sortable="true" />
                                    <PropertyColumn Property="@(log => log.Message)" Title="Message" Sortable="true" />
                                    <PropertyColumn Property="@(log => log.Exception)" Title="Exception" Sortable="true" />
                                </QuickGrid>
                                <Paginator State="@pagination" />
                            </div>
                        }
                        else
                        {
                            <p>No application logs available. Click "Refresh and Show Statistics" to load data.</p>
                        }
                    </ContentTemplate>
                </Syncfusion.Blazor.Navigations.AccordionItem>
        </Syncfusion.Blazor.Navigations.AccordionItems>
    </SfAccordion>

    </Authorized>
</AuthorizeView>



@code {
    private List<AppLog> appLogs;
    private LoginStats? loginStats;
    private List<VisitStats> visitStats;
    private List<UserVisitStats> userVisitStats;
    private List<AppLog> filteredAppLogs = new List<AppLog>();
    private bool isTransferring = false;
    private string filterString = "";
    
    protected override async Task OnInitializedAsync()
    {
        filterString = await dbContext.AppParameters
    .Where(p => p.ParamKey == "UserSiteVisitorsToExclude")
    .Select(p => p.ParamValue)
    .FirstOrDefaultAsync() ?? "";
        await GetLoginStats();
    }

    // Add pagination state
    private PaginationState pagination = new PaginationState { ItemsPerPage = 10 };
    private PaginationState userVisitPagination = new PaginationState { ItemsPerPage = 10 };
    private PaginationState visitStatsPagination = new PaginationState { ItemsPerPage = 10 };
    private PaginationState loginStatsPagination = new PaginationState { ItemsPerPage = 10 };
    
    private async Task GetLoginStats()
    {
        loginStats = await dbContext.LoginLogs
           .GroupBy(l => 1) // group everything into one bucket
           .Select(g => new LoginStats
           {
               FailedLast24Hours = g.Count(l => !l.Success && l.Timestamp >= DateTime.Now.AddDays(-1)),
               FailedLastWeek = g.Count(l => !l.Success && l.Timestamp >= DateTime.Now.AddDays(-7)),
               FailedLastMonth = g.Count(l => !l.Success && l.Timestamp >= DateTime.Now.AddMonths(-1)),
               FailedLastYear = g.Count(l => !l.Success && l.Timestamp >= DateTime.Now.AddYears(-1)),
               SuccessLast24Hours = g.Count(l => l.Success && l.Timestamp >= DateTime.Now.AddDays(-1)),
               SuccessLastWeek = g.Count(l => l.Success && l.Timestamp >= DateTime.Now.AddDays(-7)),
               SuccessLastMonth = g.Count(l => l.Success && l.Timestamp >= DateTime.Now.AddMonths(-1)),
               SuccessLastYear = g.Count(l => l.Success && l.Timestamp >= DateTime.Now.AddYears(-1))
           })
           .FirstOrDefaultAsync();

        await GetVisitLogStatsAsync();
        await GetUserVisitLogStatsAsync();
        await LoadAppLogsAsync();
    }

    private IQueryable<LoginStatsRow> GetLoginStatsAsQueryable()
    {
        if (loginStats == null)
            return new List<LoginStatsRow>().AsQueryable();

        var rows = new List<LoginStatsRow>
        {
            new LoginStatsRow { TimePeriod = "Last 24 Hours", SuccessfulLogins = loginStats.SuccessLast24Hours, FailedLogins = loginStats.FailedLast24Hours, TotalLogins = loginStats.TotalLoginAttempts24Hours },
            new LoginStatsRow { TimePeriod = "Last Week", SuccessfulLogins = loginStats.SuccessLastWeek, FailedLogins = loginStats.FailedLastWeek, TotalLogins = loginStats.TotalLoginAttemptsWeek },
            new LoginStatsRow { TimePeriod = "Last Month", SuccessfulLogins = loginStats.SuccessLastMonth, FailedLogins = loginStats.FailedLastMonth, TotalLogins = loginStats.TotalLoginAttemptsMonth },
            new LoginStatsRow { TimePeriod = "Last Year", SuccessfulLogins = loginStats.SuccessLastYear, FailedLogins = loginStats.FailedLastYear, TotalLogins = loginStats.TotalLoginAttemptsYear }
        };
        return rows.AsQueryable();
    }

    private class LoginStatsRow
    {
        public string TimePeriod { get; set; }
        public int SuccessfulLogins { get; set; }
        public int FailedLogins { get; set; }
        public int TotalLogins { get; set; }
    }

    private async Task GetVisitLogStatsAsync()
    {
        // Implement visit log statistics retrieval if needed
        var now = DateTime.UtcNow; // or DateTime.Now if you store NZ local time
        var last24h = now.AddHours(-24);
        var lastWeek = now.AddDays(-7);
        var lastMonth = now.AddMonths(-1);
        var lastYear = now.AddYears(-1);

        visitStats = await dbContext.VisitLogs
            .GroupBy(v => v.Path)
            .Select(g => new VisitStats
            {
                Location = g.Key,
                Count24h = g.Count(v => v.Timestamp >= last24h),
                CountWeek = g.Count(v => v.Timestamp >= lastWeek),
                CountMonth = g.Count(v => v.Timestamp >= lastMonth),
                CountYear = g.Count(v => v.Timestamp >= lastYear),
                UniqueUsers24h = g.Where(v => v.Timestamp >= last24h).Select(v => v.UserId ?? v.IpAddress).Distinct().Count(),
                UniqueUsersWeek = g.Where(v => v.Timestamp >= lastWeek).Select(v => v.UserId ?? v.IpAddress).Distinct().Count(),
                UniqueUsersMonth = g.Where(v => v.Timestamp >= lastMonth).Select(v => v.UserId ?? v.IpAddress).Distinct().Count(),
                UniqueUsersYear = g.Where(v => v.Timestamp >= lastYear).Select(v => v.UserId ?? v.IpAddress).Distinct().Count()
            })
            .OrderByDescending(vs => vs.CountYear)
           .ToListAsync();
    }

    private async Task GetUserVisitLogStatsAsync()
    {
        // Implement user visit log statistics retrieval 
        var now = DateTime.UtcNow; // or DateTime.Now if you store NZ local time
        var last24h = now.AddHours(-24);
        var lastWeek = now.AddDays(-7);
        var lastMonth = now.AddMonths(-1);
        var lastYear = now.AddYears(-1);
        
        // Get filter list
        var excludeList = string.IsNullOrWhiteSpace(filterString) 
            ? new HashSet<string>() 
            : filterString.Split('|', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToHashSet();
        
        //
        // Left join VisitLogs to bkg_Users on AppUserId so anonymous visits still appear.
        var allUserVisitStats = await (from v in dbContext.VisitLogs
                                join b in dbContext.bkg_Users on v.UserId equals b.AppUserId into ub
                                from b in ub.DefaultIfEmpty()
                                group v by new
                                {
                                    UserNameIpAddr = (b != null && b.UserName != null && b.UserName != "") ?
                                    (b.UserFirstName + " " + b.UserLastName + " " + b.UserName + " " + v.IpAddress ?? "Unknown").Trim() 
                                    : (v.IpAddress ?? "Unknown"),
                                    Path = v.Path
                                } into g
                                select new UserVisitStats
                                {
                                    UserNameIpAddr = g.Key.UserNameIpAddr,
                                    Location = g.Key.Path,
                                    Count24h = g.Count(v => v.Timestamp >= last24h),
                                    CountWeek = g.Count(v => v.Timestamp >= lastWeek),
                                    CountMonth = g.Count(v => v.Timestamp >= lastMonth),
                                    CountYear = g.Count(v => v.Timestamp >= lastYear)
                                })
                                .OrderByDescending(vs => vs.CountYear)
                                .ToListAsync();
        
        // Filter out excluded users/IPs
        userVisitStats = allUserVisitStats
            .Where(uvs => !excludeList.Any(exclude => uvs.UserNameIpAddr.Contains(exclude, StringComparison.OrdinalIgnoreCase)))
            .ToList();
    }

    private async Task LoadAppLogsAsync()
    {
        filteredAppLogs = await dbContext.AppLogs
            .OrderByDescending(log => log.CreatedAt)
            .ToListAsync();
    }
    private string FormatNZTime(DateTime utcDateTime)
    {
        var timeZoneId = OperatingSystem.IsWindows()
            ? "New Zealand Standard Time"
            : "Pacific/Auckland";
        var nzTimeZone = TimeZoneInfo.FindSystemTimeZoneById(timeZoneId);
        var nzTime = TimeZoneInfo.ConvertTimeFromUtc(utcDateTime, nzTimeZone);
        return nzTime.ToString("yyyy-MM-dd HH:mm:ss");
    }
}



@page "/mybookings"
@rendermode InteractiveServer
<PageTitle>RV Park My Bookings</PageTitle>

@using System.Text
@using RVPark.Data
@using Microsoft.AspNetCore.Components.Authorization
@using MediatR

@using RVPark.Services.Logging
@using RVPark.Services.Email
@using RVPark.Services.SMS

@using RVPark.Features.Bookings.DTOs
@using RVPark.Features.Bookings.Queries.GetUserBookings
@using RVPark.Features.Bookings.Queries.GetBkgUserByUsername
@using RVPark.Features.Bookings.Queries.CheckAvailability
@using RVPark.Features.Bookings.Commands.CreateBooking
@using RVPark.Features.Bookings.Commands.EditBooking
@using RVPark.Features.Bookings.Commands.DeleteBooking
@using RVPark.Features.Properties.DTOs
@using RVPark.Features.Properties.Queries.GetAllProperties
@using RVPark.Shared

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IMediator Mediator
@inject IConfiguration configuration
@inject IEmailService EmailService
@inject ISmsService SmsService
@inject IAppLogger AppLogger



<AuthorizeView>
    <Authorized>
        <section class="card-list">

            <a class="card-body" style="border: 1px solid #929292; margin-left: 1%; text-align:center;">
                <h4> Request and Add a new Booking.</h4>
                <div class="form-group" style="display:flex;flex-direction:row; text-align:center;">
                    <div class="form-group" style="text-align:center; margin-left: 1%;">
                        <label>Property</label>
                        <InputSelect select class="form-control" @bind-Value="@currentBooking.PropertyId">
                            <option value="">Select Property</option>
                            @foreach (var property in BkgProperties)
                            {
                                @if (property.PropertyId == 1)
                                {
                                    <option value="@property.PropertyId">@property.Name</option>
                                }
                            }
                        </InputSelect>
                    </div>
                    <div class="form-group" style=" text-align:center; width: 180px; margin-left: 1%">
                        <label for="fmdate">Arriving</label>
                        <SfDatePicker TValue="DateTime ?" Value="@Fmdate" Placeholder='Choose a Date' ID="fmdate" Format="dd/MM/yyyy" Locale="en-NZ">
                            <DatePickerEvents TValue="DateTime?" ValueChange="DteAriveChnge"></DatePickerEvents>
                        </SfDatePicker>
                    </div>

                    <div class="form-group" style=" text-align:center; width: 180px; margin-left: 1%">
                        <label for="tmdate">Departing</label>
                        <SfDatePicker TValue="DateTime ?" Value="@Todate" Placeholder='Choose a Date' ID="todate" Format="dd/MM/yyyy" Locale="en-NZ">
                            <DatePickerEvents TValue="DateTime?" ValueChange="DteDepartChnge"></DatePickerEvents>
                        </SfDatePicker>
                    </div>
                </div>
                <div>
                    <button class="btn btn-primary" style="min-width: 90%; text-align:center; " @onclick="CheckBkgRequest">Request Booking</button>
                </div>
            </a>
            @if (currentBkgUser == null)
            {
                <p><em>Loading...</em></p>
            }
            else
            {
                <a class="card-body" style="border: 1px solid #929292;margin-left: 1%; text-align:center;">
                    <h4> User Details.</h4>
                    <div class="form-group" style="display:flex;flex-direction:row;">
                        <div class="form-group" style=" text-align:center; margin-left: 1%">
                            <label for="username">User Name</label>
                            <input class="form-control" value="@currentBkgUser?.UserName" readonly id="username" />
                        </div>
                        <div class="form-group" style=" text-align:center; margin-left: 1%">
                            <label for="firstname">First Name</label>
                            <input class="form-control" value="@currentBkgUser?.UserFirstName" readonly id="firstname" />
                        </div>
                        <div class="form-group" style=" text-align:center; margin-left: 1%">
                            <label for="lastname">Last Name</label>
                            <input class="form-control" value="@currentBkgUser?.UserLastName" readonly id="lastname" />
                        </div>

                        <div class="form-group" style="text-align:center; margin-left: 2%;">
                            <label for="userphone">Phone</label>
                            <input class="form-control" value="@currentBkgUser?.UserPhone" readonly id="userphone" />
                        </div>
                        <div class="form-group" style="max-width: 100%; margin-left: 2% ">
                            <label for="checked">Show All</label>
                            <br />
                            <SfSwitch @bind-Checked="showAll"  style="margin-top:0.5pc;" id="checked"></SfSwitch>
                        </div>

                    </div>
                </a>
            }
        </section>
    </Authorized>
    <NotAuthorized>
        @* <p>- You Are NOT AUTHORIZED -</p> *@
    </NotAuthorized>
</AuthorizeView>

<AuthorizeView>
    <Authorized> 
        <h4>View, Change or Delete Existing Bookings</h4>
        @if (bookings == null)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #929292;">Arrives-Departs</th>
                            <th style="border: 1px solid #929292;">First Name</th>
                            <th style="border: 1px solid #929292;">Last Name</th>
                            <th style="border: 1px solid #929292;">Property Name</th>
                            <th style="border: 1px solid #929292;">Nights</th>
                            <th style="border: 1px solid #929292;">Bkg Ref</th>
                            <th style="border: 1px solid #929292;">Paid</th>
                            <th style="border: 1px solid #929292;">Status</th>
                            <th style="border: 1px solid #929292;">Comments</th>
                            <th style="border: 1px solid #929292;">Bkg Username</th>
                            <th style="border: 1px solid #929292;"><small>Edit Delete Confirm</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in bookings)
                        {
                            <tr>
                                <td style="border: 1px solid #929292;">@booking.DateArrive.ToString("dd/MM/yyyy") to @booking.DateDepart.ToString("dd/MM/yyyy")</td>
                                <td style="border: 1px solid #929292;">@booking.UserFirstName</td>
                                <td style="border: 1px solid #929292;">@booking.UserLastName</td>
                                <td style="border: 1px solid #929292;">@booking.PropertyName</td>
                                <td style="border: 1px solid #929292;">@booking.Nights</td>
                                <td style="border: 1px solid #929292;">@booking.BookingId</td>
                                <td style="border: 1px solid #929292;">@(booking.Paid ? "Y" : "N")</td>
                                <td style="border: 1px solid #929292;">@booking.BookingStatus</td>
                                <td style="border: 1px solid #929292;">@booking.BookingComments</td>
                                <td style="border: 1px solid #929292;">@booking.UserName</td>
                                <td style="border: 1px solid #929292;">
                                    <div class="tab-content" style="display:flex;flex-direction:row;">
                                        <button class="bi form-control" style="width: 40px; height: 32px;"
                                        @onclick="() => EditBooking(booking)">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <button class="bi form-control" style="width: 40px; height: 32px;"
                                        @onclick="() => DeleteBooking(booking.BookingId)">
                                            <i class="bi bi-trash3" style="block-size:max-content;"></i>
                                        </button>
                                        <button class="bi form-control" style="width: 70px; height: 32px;"
                                        @onclick="() => SendEmailConfirmation(booking.BookingId)">
                                            <i class="bi bi-chat-text" style="block-size:max-content;"></i>
                                            <i class="bi bi-envelope-arrow-up" style="block-size:max-content;"></i>
                                        </button>
                                    </div>
                                </td>

                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

    </Authorized>
    <NotAuthorized>
        <h4>- You are NOT AUTHORIZED -</h4>
    </NotAuthorized>
</AuthorizeView>

<!-- Modal Dialog for Editing/Adding Bookings for current user. -->
@if (showModal)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@modalTitle</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>

                </div>
                @if (!string.IsNullOrEmpty(modalMessage))
                {
                    <div class="modal-header" style="color:midnightblue">@modalMessage</div>
                }

                <div class="modal-body">
                    <EditForm Model="currentBooking" OnValidSubmit="SaveBooking">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        @*<div class="form-group">
                            <label>Bkg User</label>
                            <InputSelect @bind-Value="currentBooking.UserId" class="form-control">
                                @foreach (var user in users)
                                {
                                    <option value="@user.UserId">@user.UserName</option>
                                }
                            </InputSelect>
                        </div> *@
                        <div class="form-group">
                            <label>Property</label>
                                <InputSelect @bind-Value="currentBooking.PropertyId" class="form-control">
                                @foreach (var property in BkgProperties)
                                {
                                    <option value="@property.PropertyId">@property.Name</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group" style="display:flex;flex-direction:row;">
                            <div class="form-group" style=" text-align:center; width: 160px; margin-left: 1%">
                                <label for="fmdate">Arriving</label>
                                <SfDatePicker TValue="DateTime ?" Value="@Fmdate" Placeholder='Choose a Date' ID="fmdate" Format="dd/MM/yyyy" Locale="en-NZ">
                                    <DatePickerEvents TValue="DateTime?" ValueChange="DteAriveChnge"></DatePickerEvents>
                                </SfDatePicker>
                            </div>

                            <div class="form-group" style=" text-align:center; width: 160px; margin-left: 1%">
                                <label for="tmdate">Departing</label>
                                <SfDatePicker TValue="DateTime ?" Value="@Todate" Placeholder='Choose a Date' ID="todate" Format="dd/MM/yyyy" Locale="en-NZ">
                                    <DatePickerEvents TValue="DateTime?" ValueChange="DteDepartChnge"></DatePickerEvents>
                                </SfDatePicker>
                            </div>
                        </div>


                        @*                         <div class="form-group">
                            <label>Arrival Date</label>
                            <InputDate @bind-Value="currentBooking.DateArrive" onchange="DteAriveChnge" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Departure Date</label>
                            <InputDate @bind-Value="currentBooking.DateDepart" class="form-control" />
                        </div>
 *@
                        <div class="form-group">
                            <label>Status <small>(Requested,Confirmed,Paid,Arrived,Closed,Cancelled)</small></label>
                            <InputText @bind-Value="currentBooking.BookingStatus" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Comments</label>
                            <InputTextArea @bind-Value="currentBooking.BookingComments" class="form-control" />
                        </div>

                        @if (allDatesAvailable)
                        {
                            <button type="submit" class="btn btn-primary">Save</button>
                        }
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}


@if (sendConfirmMsg)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm your booking by Txt or Email</h5>
                    <button type="button" class="btn-close" @onclick="CloseConfirmModal"></button>
                </div>
                <div class="modal-header" >
                    <div class="form-group" style="display: block;">
                        <label>Confirmation to my Email</label>
                        <button type="button" class="btn btn-secondary" @onclick="SendEmailConfirmation">Email Confirmation</button>
                    </div>
                    <div class="form-group" style="display: block;">
                        <label>Txt Confirmation to Phone</label>
                        <button type="button" class="btn btn-secondary" @onclick="SendTxtConfirmation">Txt Confirmation</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}


@if (confirmSent)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmation has been sent!</h5>
                    <button type="button" class="btn-close" @onclick="CloseSent"></button>
                </div>
                <div class="modal-body">
                    <p>Emails may take many minutes to arrive depending on the email server delay they encounter. Do Please Wait.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSent">Close</button>
                </div>
            </div>
        </div>
    </div>
}


@if (confirmDelete)
{
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">About to DELETE this Booking! Confirm or Cancel as you wish?</h5>
                    <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-header">
                    <div class="form-group" style="display: block;">
                        @* <label>Confirm DELETE</label> *@
                        <button type="button" class="btn btn-secondary" @onclick="ConfirmDelete">DELETE</button>
                    </div>
                    <div class="form-group" style="display: block;">
                        @* <label>Cancel Delete</label> *@
                        <button type="button" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}


@code {
    private string BkgType = "RVPark On Fitz";
    private string isAvail = "Yes";
    public DateTime Fmdate { get; set; } = DateHelper.GetCurrentDateInNZ().Date;
    public DateTime Todate { get; set; } = DateHelper.GetCurrentDateInNZ().Date;
    private bool allDatesAvailable = false;
    private string toDelete = "no";
    private string status = string.Empty;
    private int? rqstPropertyId;

    // Properties list from MediatR query
    private List<PropertyDto> BkgProperties = new();

    // Form model for editing bookings (no longer entity)
    private BookingFormModel currentBooking = new();
    private BookingFormModel orgnBkg = new();

    private string modalTitle = string.Empty;
    private string modalMessage = string.Empty;
    private bool sendConfirmMsg = false;
    private bool showModal = false;
    private bool confirmSent = false;
    private bool confirmDelete = false;

    // Bookings list from MediatR query
    private List<BookingDto> bookings = new();

    // Current user from MediatR query
    private BkgUserDto? currentBkgUser;

    // Currently selected booking for email confirmation
    private BookingDto? selectedBookingForEmail;

    private bool _showAll = false;
    private bool showAll
    {
        get => _showAll;
        set
        {
            if (_showAll != value)
            {
                _showAll = value;
                // schedule the async refresh on the renderer/Sync context
                _ = InvokeAsync(() => RefreshTable(_showAll));
            }
        }
    }

    private int curBkgId = 0;


    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var userName = user.Identity.Name;
            // Use MediatR query instead of direct DbContext
            currentBkgUser = await Mediator.Send(new GetBkgUserByUsernameQuery(userName!));
        }

        Todate = AddOneDay(Fmdate);

        // Use MediatR query for properties instead of direct DbContext
        BkgProperties = await Mediator.Send(new GetAllPropertiesQuery(EnabledOnly: true));

        await LoadBookings();
    }
    private async Task LoadBookings()
    {
        if (currentBkgUser == null) return;

        // Use MediatR query instead of direct DbContext access
        bookings = await Mediator.Send(new GetUserBookingsQuery(
            UserId: currentBkgUser.UserId,
            IncludeClosedBookings: showAll,
            IncludeRelatedData: true
        ));
    }
    private async Task RefreshTable(bool newValue)
    {
        // keep bound value in sync (bind will already set it, but keep this for clarity)
        //showAll = newValue;
        await LoadBookings();
        StateHasChanged();
    }
    private DateTime AddOneDay(DateTime date)
    {
        return date.AddDays(1);
    }
    private DateTime SubOneDay(DateTime date)
    {
        return date.AddDays(-1);
    }

    private void DteAriveChnge(Syncfusion.Blazor.Calendars.ChangedEventArgs<DateTime?> args)
    {
        Fmdate = args.Value ?? DateHelper.GetCurrentDateInNZ(); Fmdate = Fmdate.Date;
        if (Todate <= Fmdate)
        {
            Todate = AddOneDay(Fmdate);
        }
        currentBooking.DateArrive = Fmdate.Date;
        currentBooking.DateDepart = Todate.Date;
        StateHasChanged();
    }
    private void DteDepartChnge(Syncfusion.Blazor.Calendars.ChangedEventArgs<DateTime?> args)
    {
        Todate = args.Value ?? DateHelper.GetCurrentDateInNZ(); Todate = Todate.Date;
        if (Todate <= Fmdate)
        {

            Fmdate = SubOneDay(Todate);
        }
        currentBooking.DateArrive = Fmdate.Date;
        currentBooking.DateDepart = Todate.Date;
        StateHasChanged();
    }

    private async Task CheckBkgRequest()
    {
        if (currentBkgUser == null) return;

        // Use MediatR query to check availability
        var availResult = await Mediator.Send(new CheckAvailabilityQuery(
            PropertyId: currentBooking.PropertyId,
            DateArrive: Fmdate.Date,
            DateDepart: Todate.Date
        ));

        // Prepare form model for new booking
        currentBooking = new BookingFormModel
        {
            BookingId = 0, // New booking
            PropertyId = currentBooking.PropertyId,
            UserId = currentBkgUser.UserId,
            DateArrive = Fmdate.Date,
            DateDepart = Todate.Date,
            BookingStatus = "Requested",
            PropertyName = BkgProperties.FirstOrDefault(p => p.PropertyId == currentBooking.PropertyId)?.Name
        };

        if (availResult.IsSuccess && availResult.Value)
        {
            modalTitle = "Booking Requested";
            modalMessage = "Your booking request is AVAILABLE. Please press SAVE to confirm or CANCEL to quit.";
            allDatesAvailable = true;
        }
        else
        {
            modalTitle = "Booking Request Failed";
            modalMessage = availResult.Error ?? "Sorry but your booking request is not possible.";
            allDatesAvailable = false;
        }
        showModal = true;
    }

    private void EditBooking(BookingDto bookingDto)
    {
        // Store original values for comparison
        orgnBkg = new BookingFormModel
        {
            BookingId = bookingDto.BookingId,
            PropertyId = bookingDto.PropertyId,
            UserId = bookingDto.UserId,
            DateArrive = bookingDto.DateArrive,
            DateDepart = bookingDto.DateDepart,
            TotalPrice = bookingDto.TotalPrice,
            Paid = bookingDto.Paid,
            BookingStatus = bookingDto.BookingStatus,
            BookingComments = bookingDto.BookingComments ?? "",
            PropertyName = bookingDto.PropertyName
        };

        // Populate form model for editing
        currentBooking = new BookingFormModel
        {
            BookingId = bookingDto.BookingId,
            PropertyId = bookingDto.PropertyId,
            UserId = bookingDto.UserId,
            DateArrive = bookingDto.DateArrive,
            DateDepart = bookingDto.DateDepart,
            TotalPrice = bookingDto.TotalPrice,
            Paid = bookingDto.Paid,
            BookingStatus = bookingDto.BookingStatus,
            BookingComments = bookingDto.BookingComments ?? "",
            PropertyName = bookingDto.PropertyName
        };

        Fmdate = bookingDto.DateArrive;
        Todate = bookingDto.DateDepart;

        modalTitle = "Edit Booking";
        modalMessage = "";
        allDatesAvailable = true;
        showModal = true;
    }

    private void DeleteBooking(int bookingId)
    {
        curBkgId = bookingId;
        confirmDelete = true;

        // var booking = await ApplicationDbContext.bkg_Bookings.FindAsync(bookingId);
        // if (booking != null)
        // {
        //     try
        //     {
        //         string subjectMsg = string.Concat("WARNING", " BkgRef: ", booking.BookingId.ToString(), " for ", booking.Bkg_Property.Name,
        //         " from ", booking.DateArrive.Date.ToString("d"), " to ", booking.DateDepart.Date.ToString("d"), " HAS BEEN DELETED");

        //         string CCMsg = string.Concat("CC msg of email to:", booking.Bkg_User.UserEmail, " Warning BkgRef: ", booking.BookingId.ToString(),
        //         " for ", booking.Bkg_Property.Name, " from ", booking.DateArrive.Date.ToString("d"), " to ", booking.DateDepart.Date.ToString("d"), " HAS BEEN DELETED");

        //         await BookingEngine.DeleteBookingAsync(booking);
        //         await LoadBookings();
        //         string s = configuration["TNZ:SMSrept"];
        //         string txtrept = Chk_E_164_Phone(s);
        //         SendTxtConfirmation(subjectMsg, txtrept, "WARNING");
        //         // Need to send a cc'd to rvpark@pontifex.nz
        //         SendCCEmailDeleteConfirmation(CCMsg, "Warning");
        //     }
        //     catch (Exception ex)
        //     {
        //         modalTitle = "Error found deleting this Booking";
        //         modalMessage = ex.ToString();
        //         allDatesAvailable = false;
        //         showModal = true;
        //     }

        //     // await LoadBookings();
        // }
    }
    private void CancelDelete()
    {
        confirmDelete = false;
        curBkgId = 0;
    }

    private async Task ConfirmDelete()
    {
        // Find the booking in our list for confirmation message details
        var bookingDto = bookings.FirstOrDefault(b => b.BookingId == curBkgId);
        if (bookingDto == null)
        {
            confirmDelete = false;
            curBkgId = 0;
            return;
        }

        try
        {
            string subjectMsg = string.Concat("WARNING", " BkgRef: ", bookingDto.BookingId.ToString(), " for ", bookingDto.PropertyName,
            " from ", bookingDto.DateArrive.Date.ToString("dd/MM/yyyy"), " to ", bookingDto.DateDepart.Date.ToString("dd/MM/yyyy"), " HAS BEEN DELETED");

            string CCMsg = string.Concat("CC msg of email to:", bookingDto.UserEmail, " Warning BkgRef: ", bookingDto.BookingId.ToString(),
            " for ", bookingDto.PropertyName, " from ", bookingDto.DateArrive.Date.ToString("dd/MM/yyyy"), " to ", bookingDto.DateDepart.Date.ToString("dd/MM/yyyy"), " HAS BEEN DELETED");

            // Use MediatR DeleteBookingCommand
            var result = await Mediator.Send(new DeleteBookingCommand(curBkgId));

            if (!result.IsSuccess)
            {
                modalTitle = "Error found deleting this Booking";
                modalMessage = result.Error ?? "Unable to delete booking";
                allDatesAvailable = false;
                showModal = true;
            }
            else
            {
                await LoadBookings();
                StateHasChanged();
                string s = configuration["TNZ:SMSrept"] ?? string.Empty;
                string txtrept = Chk_E_164_Phone(s);
                await SendTxtConfirmation(subjectMsg, txtrept, "WARNING");
                // Need to send a cc'd to rvpark@pontifex.nz
                await SendCCEmailDeleteConfirmation(CCMsg, subjectMsg);
            }
        }
        catch (Exception ex)
        {
            modalTitle = "Error found deleting this Booking";
            modalMessage = ex.ToString();
            allDatesAvailable = false;
            showModal = true;
        }

        curBkgId = 0;
        confirmDelete = false;
    }

    private void CloseModal()
    {
        showModal = false;
    }
    private void CloseConfirmModal()
    {
        sendConfirmMsg = false;
    }
    private void CloseSent()
    {
        confirmSent = false;
    }
    private async Task SaveBooking()
    {
        if (currentBkgUser == null) return;

        string s = configuration["SMSSettings:SMSrept"] ?? string.Empty;
        string txtrept = Chk_E_164_Phone(s);
        currentBooking.DateArrive = Fmdate;
        currentBooking.DateDepart = Todate;

        // Get property name for confirmations
        currentBooking.PropertyName = BkgProperties.FirstOrDefault(p => p.PropertyId == currentBooking.PropertyId)?.Name;

        // if a new booking then we need to Create it else Change it.
        if (currentBooking.BookingId == 0) // A new booking
        {
            // Use MediatR CreateBookingCommand
            var result = await Mediator.Send(new CreateBookingCommand(
                PropertyId: currentBooking.PropertyId,
                UserId: currentBkgUser.UserId,
                DateArrive: currentBooking.DateArrive,
                DateDepart: currentBooking.DateDepart,
                TotalPrice: currentBooking.TotalPrice,
                BookingComments: currentBooking.BookingComments
            ));

            if (!result.IsSuccess)
            {
                modalMessage = result.Error ?? "Error found saving this new Booking";
                allDatesAvailable = false;
                showModal = true;
                return;
            }

            // Update currentBooking with the new BookingId for confirmation messages
            currentBooking.BookingId = result.Value?.BookingId ?? 0;

            // Send confirmations
            await SendEmailConfirmationForBooking();
            await SendTxtConfirmation(txtrept);
            await SendCCEmailConfirmation();
        }
        else // editing existing bkg
        {
            // Use MediatR EditBookingCommand
            var result = await Mediator.Send(new EditBookingCommand(
                BookingId: currentBooking.BookingId,
                PropertyId: currentBooking.PropertyId,
                UserId: currentBooking.UserId,
                DateArrive: currentBooking.DateArrive,
                DateDepart: currentBooking.DateDepart,
                TotalPrice: currentBooking.TotalPrice,
                Paid: currentBooking.Paid,
                BookingStatus: currentBooking.BookingStatus,
                BookingComments: currentBooking.BookingComments
            ));

            if (!result.IsSuccess)
            {
                modalMessage = result.Error ?? "Error found saving this edited Booking";
                allDatesAvailable = false;
                showModal = true;
                return;
            }

            // Send confirmations
            await SendEmailConfirmationForBooking();
            await SendTxtConfirmation(txtrept);
            await SendCCEmailConfirmation();
        }

        showModal = false;
        confirmSent = true;
        await LoadBookings();
        StateHasChanged();
    }
    private void SendEmailConfirmation(int bookingId)
    {
        // Find booking in list for email dialog
        selectedBookingForEmail = bookings.FirstOrDefault(b => b.BookingId == bookingId);
        if (selectedBookingForEmail != null)
        {
            sendConfirmMsg = true;
        }
    }

    private async Task SendEmailConfirmation()
    {
        // Called from modal dialog - uses selectedBookingForEmail
        if (selectedBookingForEmail == null) return;

        string subjectMsg = string.Concat("BkgRef: ", selectedBookingForEmail.BookingId.ToString(), " for ", selectedBookingForEmail.PropertyName,
        " from ", selectedBookingForEmail.DateArrive.Date.ToString("dd/MM/yyyy"), " to ", selectedBookingForEmail.DateDepart.Date.ToString("dd/MM/yyyy"));

        string emailTo = selectedBookingForEmail.UserEmail ?? "";
        var resultMsg = await EmailService.SendEmailAsync(emailTo, subjectMsg, ConfirmBkgMsgForBooking(selectedBookingForEmail));
        if (resultMsg)
        {
            modalTitle = "Adhoc Email Sent"; modalMessage = string.Concat("Adhoc Email Confirmation sent to ", emailTo);
        }
        else
        {
            modalTitle = "Adhoc Email NOT Sent"; modalMessage = string.Concat("Adhoc Email Confirmation could NOT be sent to ", emailTo);
        }

        sendConfirmMsg = false;
    }

    private async Task SendEmailConfirmationForBooking()
    {
        // Called after save - uses currentBooking form model
        string subjectMsg = string.Concat("BkgRef: ", currentBooking.BookingId.ToString(), " for ", currentBooking.PropertyName,
        " from ", currentBooking.DateArrive.Date.ToString("dd/MM/yyyy"), " to ", currentBooking.DateDepart.Date.ToString("dd/MM/yyyy"));

        string emailTo = currentBkgUser?.UserEmail ?? "";
        var resultMsg = await EmailService.SendEmailAsync(emailTo, subjectMsg, ConfirmBkgMsg());
        if (resultMsg)
        {
            modalTitle = "Email Sent"; modalMessage = string.Concat("Email Confirmation sent to ", emailTo);
        }
        else
        {
            modalTitle = "Email NOT Sent"; modalMessage = string.Concat("Email Confirmation could NOT be sent to ", emailTo);
        }
    }
    private async Task SendCCEmailConfirmation()
    {
        string subjectMsg = string.Concat("CC msg of email to:", currentBkgUser?.UserEmail, " BkgRef: ", currentBooking.BookingId.ToString(), " for ", currentBooking.PropertyName,
        " from ", currentBooking.DateArrive.Date.ToString("dd/MM/yyyy"), " to ", currentBooking.DateDepart.Date.ToString("dd/MM/yyyy"));

        string emailTo = configuration["EmailSettings:CCEmail"] ?? "";
        var resultMsg = await EmailService.SendEmailAsync(emailTo, subjectMsg, ConfirmBkgMsg());
        if (resultMsg)
        {
            modalTitle = "CC Email Sent"; modalMessage = string.Concat("CC Email Confirmation sent to ", emailTo);
        }
        else
        {
            modalTitle = "CC Email NOT Sent"; modalMessage = string.Concat("CC Email Confirmation could NOT be sent to ", emailTo);
        }
    }
    private async Task SendCCEmailDeleteConfirmation(string subjectMsg, string DeleteMsg)
    {
        // string subjectMsg = string.Concat("CC msg of email to:", currentBooking.Bkg_User.UserEmail, DeleteMsg, " BkgRef: ", currentBooking.BookingId.ToString(), " for ", currentBooking.Bkg_Property.Name,
        // " from ", currentBooking.DateArrive.Date.ToString("d"), " to ", currentBooking.DateDepart.Date.ToString("d"), " HAS BEEN DELETED");
        string emailTo = configuration["EmailSettings:CCEmail"] ?? string.Empty;
        var resultMsg = await EmailService.SendEmailAsync(emailTo, subjectMsg, DeleteMsg);
        if (resultMsg)
        {
            modalTitle = "Adhoc Email Sent"; modalMessage = string.Concat("Adhoc Email Confirmation sent to ", emailTo);
        }
        else
        {
            modalTitle = "Adhoc Email NOT Sent"; modalMessage = string.Concat("Adhoc Email Confirmation could NOT be sent to ", emailTo);
        }

        sendConfirmMsg = false;
        StateHasChanged();
    }
    private async Task SendTxtConfirmation()
    {
        // Called from modal dialog - uses selectedBookingForEmail
        if (selectedBookingForEmail == null) return;

        string txtrept = Chk_E_164_Phone(selectedBookingForEmail.UserPhone ?? "");
        string subjectMsg = string.Concat("BkgRef: ", selectedBookingForEmail.BookingId.ToString(), " for ", selectedBookingForEmail.PropertyName,
        " from ", selectedBookingForEmail.DateArrive.Date.ToString("dd/MM/yyyy"), " to ", selectedBookingForEmail.DateDepart.Date.ToString("dd/MM/yyyy"));

        var smsrqst = new SmsRequest
        {
            To = txtrept,
            Message = subjectMsg
        };
        SmsResponse resultMsg = await SmsService.SendSmsAsync(smsrqst);
        if (resultMsg.Success)
        {
            modalTitle = "SMS Msg Sent"; modalMessage = string.Concat("SMS Msg Confirmation sent to ", txtrept);
        }
        else
        {
            modalTitle = "SMS Msg NOT Sent"; modalMessage = string.Concat("SMS Msg could NOT be sent to ", txtrept);
        }

        sendConfirmMsg = false;
        StateHasChanged();
    }

    private async Task SendTxtConfirmation(string subjectMsg, string txtrept, string DeleteMsg)
    {
        var smsrqst = new SmsRequest
        {
            To = txtrept,
            Message = subjectMsg
        };
        SmsResponse resultMsg = await SmsService.SendSmsAsync(smsrqst);
        if (resultMsg.Success)
        {
            modalTitle = "SMS Msg Sent"; modalMessage = string.Concat("SMS Msg Confirmation sent to ", txtrept);
        }
        else
        {
            modalTitle = "SMS Msg NOT Sent"; modalMessage = string.Concat("SMS Msg could NOT be sent to ", txtrept);
        }

        sendConfirmMsg = false;
        StateHasChanged();
    }

    private async Task SendTxtConfirmation(string txtrept)
    {
        string subjectMsg = string.Concat("BkgRef: ", currentBooking.BookingId.ToString(), " for ", currentBooking.PropertyName,
        " from ", currentBooking.DateArrive.Date.ToString("dd/MM/yyyy"), " to ", currentBooking.DateDepart.Date.ToString("dd/MM/yyyy"));

        if (string.IsNullOrEmpty(txtrept))
        {
            txtrept = Chk_E_164_Phone(currentBkgUser?.UserPhone ?? "");
        }
        var smsrqst = new SmsRequest
        {
            To = txtrept,
            Message = ConfirmTxtBkgMsg()
        };
        SmsResponse resultMsg = await SmsService.SendSmsAsync(smsrqst);
        if (resultMsg.Success)
        {
            modalTitle = "SMS Msg Sent"; modalMessage = string.Concat("SMS Msg Confirmation sent to ", txtrept);
        }
        else
        {
            modalTitle = "SMS Msg NOT Sent"; modalMessage = string.Concat("SMS Msg Confirmation could NOT be sent to ", txtrept);
        }
        sendConfirmMsg = false;
        StateHasChanged();
    }
    private async Task SendTxtConfirmationNoEmail(string txtrept)
    {
        string subjectMsg = string.Concat("BkgRef: ", currentBooking.BookingId.ToString(), " for ", currentBooking.PropertyName,
        " from ", currentBooking.DateArrive.Date.ToString("dd/MM/yyyy"), " to ", currentBooking.DateDepart.Date.ToString("dd/MM/yyyy"));

        if (string.IsNullOrEmpty(txtrept))
        {
            txtrept = Chk_E_164_Phone(currentBkgUser?.UserPhone ?? "");
        }
        var smsrqst = new SmsRequest
        {
            To = txtrept,
            Message = ConfirmBkgMsg()
        };
        SmsResponse resultMsg = await SmsService.SendSmsAsync(smsrqst);
        if (resultMsg.Success)
        {
            modalTitle = "SMS Msg Sent"; modalMessage = string.Concat("SMS Msg Confirmation sent to ", txtrept);
        }
        else
        {
            modalTitle = "SMS Msg NOT Sent"; modalMessage = string.Concat("SMS Msg Confirmation could NOT be sent to ", txtrept);
        }
        sendConfirmMsg = false;
        StateHasChanged();
    }


    private string ConfirmBkgMsg()
    {
        StringBuilder sb = new StringBuilder();
        sb.Append("Kia ora ");
        sb.Append(currentBkgUser?.UserFirstName);
        sb.Append(" ");
        sb.Append(currentBkgUser?.UserLastName);
        sb.Append("\n\n");
        sb.Append("BkgRef:");
        sb.Append(currentBooking.BookingId.ToString());
        sb.Append(" Has been confirmed, or reconfirmed for ");
        sb.Append(currentBooking.PropertyName);
        sb.Append(" arriving after mid-day ");
        sb.Append(currentBooking.DateArrive.Date.ToString("dd/MM/yyyy"));
        sb.Append(" departing before mid-day ");
        sb.Append(currentBooking.DateDepart.Date.ToString("dd/MM/yyyy"));
        sb.Append("\n\n");
        sb.Append("Address is\r\n" +
                  "        22 Fitzpatrick St\r\n" +
                  "        Newlands\r\n" +
                  "        Wellington 6037\r\n\r\n" +
                  "Access is best from Stewart Drive. Either from the north where you would exit SH1 at Johnsonville or from the South also through Johnsonville's main street. Turn into Fitzpatrick St from Stewart Drive is best. " +
                  "We are on the left corner of the 2nd street on the left going up Fitzpatrick St.\r\n\r\n" +
                  "Access from Stewart Drive is also possible via Quigley St. Follow Quigley Street around until it T-intersects with Fitzpatrick St. Your park is then on the left of that intersection.\r\n\r\n" +
                  "https://www.rvpark.nz/directions click for map from the South \r\n" +
                  "https://www.rvpark.nz/directionsnorth click for map from the North \r\n" + 
                  "PLEASE BE AWARE: Some of the roads in Newlands are NOT suitable for RVs and larger vehicles SO DO NOT FOLLOW THE Map Apps THEY WILL GET YOU STUCK... Really We Are Not Kidding.\r\n\r\n" +
                  "Payment is $30 for the night with NZMCA Memebrship otherwise $45 per night, payable in advance please to our bank account.\r\n" +
                  "        Ronald Pontifex\r\n" +
                  "        03 0525 0253043 000\r\n" +
                  "(We have Wise Card if that suits you better.)\r\n\r\n" +
                  "Please text us on arrival and we shall come out to meets you etc.\r\n" +
                  "Again many thanks\r\n" +
                  "Ron Pontifex\r\n" +
                  "WELLINGTON New Zealand\r\n" +
                  "Ph 027 304 2002\r\n" +
                  "E - Mail : rvpark@pontifex.nz\r\n"); return sb.ToString();
    }
    private string ConfirmBkgMsgNoEmail()
    {
        StringBuilder sb = new StringBuilder();
        sb.Append("Kia ora ");
        sb.Append(currentBkgUser?.UserFirstName);
        sb.Append(" ");
        sb.Append(currentBkgUser?.UserLastName);
        sb.Append("\n\n");
        sb.Append("BkgRef:");
        sb.Append(currentBooking.BookingId.ToString());

        sb.Append(" Has been confirmed, or reconfirmed for ");
        sb.Append(currentBooking.PropertyName);
        sb.Append(" arriving after mid-day ");
        sb.Append(currentBooking.DateArrive.Date.ToString("dd/MM/yyyy"));
        sb.Append(" departing before mid-day ");
        sb.Append(currentBooking.DateDepart.Date.ToString("dd/MM/yyyy"));
        sb.Append("\n\n");
        sb.Append("Address is\r\n" +
                  "        22 Fitzpatrick St\r\n" +
                  "        Newlands\r\n" +
                  "        Wellington 6037\r\n\r\n" +
                  "Access is best from Stewart Drive. Either from the north where you would exit SH1 at Johnsonville or from the South also through Johnsonville's main street. Turn into Fitzpatrick St from Stewart Drive is best. " +
                  "We are on the left corner of the 2nd street on the left going up Fitzpatrick St.\r\n\r\n" +
                  "Access from Stewart Drive is also possible via Quigley St. Follow Quigley Street around until it T-intersects with Fitzpatrick St. Your park is then on the left of that intersection.\r\n\r\n" +
                  "https://www.rvpark.nz/directions click for map from the South \r\n" +
                  "https://www.rvpark.nz/directionsnorth click for map from the North \r\n" +
                  "PLEASE BE AWARE: Some of the roads in Newlands are NOT suitable for RVs and larger vehicles SO DO NOT FOLLOW THE Map Apps THEY WILL GET YOU STUCK... Really We Are Not Kidding.\r\n\r\n" +
                  "Payment is $30 for the night with NZMCA Memebrship otherwise $45 per night, payable in advance please to our bank account.\r\n" +
                  "        Ronald Pontifex\r\n" +
                  "        03 0525 0253043 000\r\n" +
                  "(We have Wise Card if that suits you better.)\r\n\r\n" +
                  "Please text us on arrival and we shall come out to meets you etc.\r\n" +
                  "Again many thanks\r\n" +
                  "Ron Pontifex\r\n" +
                  "WELLINGTON New Zealand\r\n" +
                  "Ph 027 304 2002\r\n" +
                  "E - Mail : rvpark@pontifex.nz\r\n"); return sb.ToString();
    }

    private string ConfirmBkgMsgForBooking(BookingDto booking)
    {
        StringBuilder sb = new StringBuilder();
        sb.Append("Kia ora ");
        sb.Append(booking.UserFirstName);
        sb.Append(" ");
        sb.Append(booking.UserLastName);
        sb.Append("\n\n");
        sb.Append("BkgRef:");
        sb.Append(booking.BookingId.ToString());
        sb.Append(" Has been confirmed, or reconfirmed for ");
        sb.Append(booking.PropertyName);
        sb.Append(" arriving after mid-day ");
        sb.Append(booking.DateArrive.Date.ToString("dd/MM/yyyy"));
        sb.Append(" departing before mid-day ");
        sb.Append(booking.DateDepart.Date.ToString("dd/MM/yyyy"));
        sb.Append("\n\n");
        sb.Append("Address is\r\n" +
                  "        22 Fitzpatrick St\r\n" +
                  "        Newlands\r\n" +
                  "        Wellington 6037\r\n\r\n" +
                  "Access is best from Stewart Drive. Either from the north where you would exit SH1 at Johnsonville or from the South also through Johnsonville's main street. Turn into Fitzpatrick St from Stewart Drive is best. " +
                  "We are on the left corner of the 2nd street on the left going up Fitzpatrick St.\r\n\r\n" +
                  "Access from Stewart Drive is also possible via Quigley St. Follow Quigley Street around until it T-intersects with Fitzpatrick St. Your park is then on the left of that intersection.\r\n\r\n" +
                  "https://www.rvpark.nz/directions click for map from the South \r\n" +
                  "https://www.rvpark.nz/directionsnorth click for map from the North \r\n" +
                  "PLEASE BE AWARE: Some of the roads in Newlands are NOT suitable for RVs and larger vehicles SO DO NOT FOLLOW THE Map Apps THEY WILL GET YOU STUCK... Really We Are Not Kidding.\r\n\r\n" +
                  "Payment is $30 for the night with NZMCA Memebrship otherwise $45 per night, payable in advance please to our bank account.\r\n" +
                  "        Ronald Pontifex\r\n" +
                  "        03 0525 0253043 000\r\n" +
                  "(We have Wise Card if that suits you better.)\r\n\r\n" +
                  "Please text us on arrival and we shall come out to meets you etc.\r\n" +
                  "Again many thanks\r\n" +
                  "Ron Pontifex\r\n" +
                  "WELLINGTON New Zealand\r\n" +
                  "Ph 027 304 2002\r\n" +
                  "E - Mail : rvpark@pontifex.nz\r\n"); return sb.ToString();
    }

    private string ConfirmTxtBkgMsg()
    {
        StringBuilder sb = new StringBuilder();
        sb.Append("Kia ora ");
        sb.Append(currentBkgUser?.UserFirstName);
        sb.Append(" ");
        sb.Append(currentBkgUser?.UserLastName);
        sb.Append("\n\n");
        sb.Append("BkgRef:");
        sb.Append(currentBooking.BookingId.ToString());
        sb.Append(" Has been confirmed, or reconfirmed for ");
        sb.Append(currentBooking.PropertyName);
        sb.Append(" arriving after mid-day ");
        sb.Append(currentBooking.DateArrive.Date.ToString("dd/MM/yyyy"));
        sb.Append(" departing before mid-day ");
        sb.Append(currentBooking.DateDepart.Date.ToString("dd/MM/yyyy"));
        sb.Append("\n\n");
        sb.Append("Please refer to your Bkg confirmation Email for full Details.\r\n" +
                 "from : rvpark@pontifex.nz\r\n");return sb.ToString();
    }
    private string Chk_E_164_Phone(string phne)
    {
        string srtn = string.Empty;
        if (phne.Length > 0)
        {
            if (phne.StartsWith("+")) // then likely in the corect format already
            {
                srtn = phne.Trim();
            }
            else if (phne.StartsWith("0"))// then likely miss country code so remove the "0" and add "+64"
            {
                srtn = string.Concat("+64" + phne[1..]); // this prefix should be a configurable for the ountry the app is being run in.
            }
        }
        return srtn;
    }

    /// <summary>
    /// Form model for creating/editing bookings - no EF entity dependency
    /// </summary>
    private class BookingFormModel
    {
        public int BookingId { get; set; }
        public int PropertyId { get; set; }
        public int UserId { get; set; }
        public DateTime DateArrive { get; set; } = DateHelper.GetCurrentDateInNZ().Date;
        public DateTime DateDepart { get; set; } = DateHelper.GetCurrentDateInNZ().Date.AddDays(1);
        public decimal TotalPrice { get; set; }
        public bool Paid { get; set; }
        public string BookingStatus { get; set; } = "Requested";
        public string BookingComments { get; set; } = "";
        public string? PropertyName { get; set; }
    }
}

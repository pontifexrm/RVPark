@page "/Auth/Register"
@layout MainLayout
@inject IMediator Mediator
@inject NavigationManager NavigationManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject UserManager<ApplicationUser> UserManager
@using Microsoft.AspNetCore.Identity
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.WebUtilities

<PageTitle>Register</PageTitle>

<h1>Register</h1>

<div class="row">
    <div class="col-lg-6">
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                @_errorMessage
            </div>
        }

        @if (_registrationComplete)
        {
            <div class="alert alert-success" role="alert">
                <h4>Registration Successful!</h4>
                <p>Please check your email to confirm your account before logging in.</p>
                <a href="Auth/Login" class="btn btn-primary">Go to Login</a>
            </div>
        }
        else
        {
            <EditForm Model="_model" OnValidSubmit="HandleRegister">
                <DataAnnotationsValidator />
                <h2>Create a new account.</h2>
                <hr />
                <ValidationSummary class="text-danger" role="alert" />

                <div class="form-floating mb-3">
                    <InputText @bind-Value="_model.Email" id="email" class="form-control"
                               autocomplete="username" aria-required="true" placeholder="name@example.com" />
                    <label for="email">Email</label>
                    <ValidationMessage For="() => _model.Email" class="text-danger" />
                </div>

                <div class="form-floating mb-3">
                    <InputText type="password" @bind-Value="_model.Password" id="password"
                               class="form-control" autocomplete="new-password"
                               aria-required="true" placeholder="password" />
                    <label for="password">Password</label>
                    <ValidationMessage For="() => _model.Password" class="text-danger" />
                </div>

                <div class="form-floating mb-3">
                    <InputText type="password" @bind-Value="_model.ConfirmPassword" id="confirmPassword"
                               class="form-control" autocomplete="new-password"
                               aria-required="true" placeholder="confirm password" />
                    <label for="confirmPassword">Confirm Password</label>
                    <ValidationMessage For="() => _model.ConfirmPassword" class="text-danger" />
                </div>

                <div class="form-floating mb-3">
                    <InputText @bind-Value="_model.FirstName" id="firstName" class="form-control"
                               autocomplete="given-name" aria-required="true" placeholder="First Name" />
                    <label for="firstName">First Name</label>
                    <ValidationMessage For="() => _model.FirstName" class="text-danger" />
                </div>

                <div class="form-floating mb-3">
                    <InputText @bind-Value="_model.LastName" id="lastName" class="form-control"
                               autocomplete="family-name" aria-required="true" placeholder="Last Name" />
                    <label for="lastName">Last Name</label>
                    <ValidationMessage For="() => _model.LastName" class="text-danger" />
                </div>

                <div class="form-floating mb-3">
                    <InputText @bind-Value="_model.Mobile" id="mobile" class="form-control"
                               autocomplete="tel" placeholder="Mobile Phone" />
                    <label for="mobile">Mobile Phone</label>
                    <ValidationMessage For="() => _model.Mobile" class="text-danger" />
                </div>

                <div class="text-body mb-3">
                    Once you have registered and confirmed with the email link, please use your Profile page to enter your other details.
                </div>

                <button type="submit" class="w-100 btn btn-lg btn-primary" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span> Registering...</span>
                    }
                    else
                    {
                        <span>Register</span>
                    }
                </button>

                <div class="mt-3">
                    <p>Already have an account? <a href="@GetLoginUrl()">Log in here</a></p>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    private RegisterModel _model = new();
    private string? _errorMessage;
    private bool _isLoading;
    private bool _registrationComplete;

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    private async Task HandleRegister()
    {
        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            // Register via MediatR
            var result = await Mediator.Send(new RegisterCommand(
                _model.Email,
                _model.Password,
                _model.ConfirmPassword,
                _model.FirstName,
                _model.LastName,
                _model.Mobile
            ));

            if (result.Succeeded)
            {
                // Send confirmation email
                await SendConfirmationEmailAsync(result.UserId!, result.Email!);

                if (result.RequiresEmailConfirmation)
                {
                    _registrationComplete = true;
                }
                else
                {
                    // Auto-login not requiring email confirmation
                    NavigationManager.NavigateTo(ReturnUrl ?? "/", forceLoad: true);
                }
            }
            else
            {
                _errorMessage = result.ErrorMessage ?? "Registration failed.";
                if (result.Errors?.Any() == true)
                {
                    _errorMessage = string.Join(" ", result.Errors);
                }
            }
        }
        catch (FluentValidation.ValidationException ex)
        {
            _errorMessage = string.Join(", ", ex.Errors.Select(e => e.ErrorMessage));
        }
        catch (Exception)
        {
            _errorMessage = "An error occurred during registration. Please try again.";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SendConfirmationEmailAsync(string userId, string email)
    {
        var user = await UserManager.FindByIdAsync(userId);
        if (user == null) return;

        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code, ["returnUrl"] = ReturnUrl });

        await EmailSender.SendConfirmationLinkAsync(user, email, HtmlEncoder.Default.Encode(callbackUrl));
    }

    private string GetLoginUrl()
    {
        var baseUrl = "Auth/Login";
        if (!string.IsNullOrEmpty(ReturnUrl))
        {
            return $"{baseUrl}?ReturnUrl={Uri.EscapeDataString(ReturnUrl)}";
        }
        return baseUrl;
    }

    private class RegisterModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.EmailAddress]
        public string Email { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.StringLength(100, MinimumLength = 6, ErrorMessage = "Password must be at least 6 characters.")]
        [System.ComponentModel.DataAnnotations.DataType(System.ComponentModel.DataAnnotations.DataType.Password)]
        public string Password { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.Compare("Password", ErrorMessage = "Passwords do not match.")]
        [System.ComponentModel.DataAnnotations.DataType(System.ComponentModel.DataAnnotations.DataType.Password)]
        public string ConfirmPassword { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required]
        public string FirstName { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required]
        public string LastName { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Phone]
        public string? Mobile { get; set; }
    }
}

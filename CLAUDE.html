<h1 id="claude.md">CLAUDE.md</h1>
<p>This file provides guidance to Claude Code (claude.ai/code) when
working with code in this repository.</p>
<h2 id="project-overview">Project Overview</h2>
<p>RVPark is an RV Park booking and management system built with ASP.NET
Core 10.0 Blazor (Interactive Server-Side Rendering). It manages RV park
properties, bookings, availability calendars, and user accounts.</p>
<h2 id="build-run-commands">Build &amp; Run Commands</h2>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dotnet</span> build</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">dotnet</span> build <span class="at">-c</span> Release</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Run locally (HTTP: localhost:5000, HTTPS: localhost:5001)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">dotnet</span> run</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Database migrations</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="ex">dotnet</span> ef database update</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Publish profiles available in Properties/PublishProfiles/</span></span></code></pre></div>
<h2 id="technology-stack">Technology Stack</h2>
<ul>
<li><strong>Framework:</strong> ASP.NET Core 10.0, Blazor Server</li>
<li><strong>Database:</strong> SQL Server with Entity Framework Core
10.0.1</li>
<li><strong>Auth:</strong> ASP.NET Core Identity with roles (Admin,
Manager, User)</li>
<li><strong>UI Components:</strong> Syncfusion Blazor 32.x,
Blazor.Bootstrap 3.5, Bootstrap 5.3</li>
<li><strong>Email:</strong> MailKit (primary), SMTP, TNZ API (pluggable
via DI)</li>
<li><strong>SMS:</strong> SMSEveryone, TNZ SMS (pluggable via DI)</li>
<li><strong>Mapping:</strong> AutoMapper 16.0</li>
<li><strong>CQRS/Mediator:</strong> MediatR 12.4.0</li>
<li><strong>Validation:</strong> FluentValidation 11.11.0</li>
</ul>
<h2 id="architecture">Architecture</h2>
<p>The project uses a hybrid architecture combining traditional Blazor
structure with Vertical Slice Architecture (VSA) for core features.</p>
<pre><code>RVPark/
├── Components/           # Razor components (UI)
│   ├── Account/          # Identity/auth components
│   ├── Admin/            # Admin management pages
│   ├── Layout/           # MainLayout, NavMenu, NavBar
│   └── Pages/            # Public-facing pages
├── Data/                 # Entity models &amp; DbContext
│   ├── ApplicationDbContext.cs
│   ├── Bkg_*.cs          # Booking domain models
│   └── Bkg_Engine.cs     # Legacy booking logic (kept for reference)
├── Features/             # Vertical Slice Architecture (VSA)
│   ├── Authentication/   # Login, Register, Logout
│   │   ├── Commands/     # LoginCommand, RegisterCommand, LogoutCommand
│   │   ├── Queries/      # GetCurrentUserQuery
│   │   ├── DTOs/         # AuthResultDto, CurrentUserDto
│   │   ├── Services/     # IAuthenticationService, AuthenticationService
│   │   └── Pages/        # Login.razor, Register.razor
│   ├── Bookings/         # Booking management
│   │   ├── Commands/     # CreateBooking, EditBooking, DeleteBooking
│   │   ├── Queries/      # GetBookingById, GetUserBookings, CheckAvailability
│   │   ├── DTOs/         # BookingDto
│   │   ├── Services/     # IBookingEngine, BookingEngine (7 edit scenarios)
│   │   └── MappingProfiles/
│   └── Properties/       # Property management
│       ├── Commands/     # UpdatePropertyCommand
│       ├── Queries/      # GetAllProperties, GetPropertyById
│       ├── DTOs/         # PropertyDto
│       ├── Pages/        # PropertyList.razor
│       └── MappingProfiles/
├── Shared/               # Cross-cutting concerns
│   ├── Result.cs         # Result&lt;T&gt; pattern for operation outcomes
│   └── Behaviors/        # MediatR pipeline behaviors
│       └── ValidationBehavior.cs
├── Services/             # Infrastructure services
│   ├── Email/            # IEmailService implementations
│   ├── SMS/              # ISmsService implementations
│   ├── Logging/          # IAppLogger, request middleware
│   └── ServiceExtensions.cs
├── Migrations/           # EF Core migrations
└── Program.cs            # Startup configuration &amp; DI registration</code></pre>
<h2 id="core-domain-models-data">Core Domain Models (Data/)</h2>
<ul>
<li><strong>Bkg_Property</strong> - RV park property with amenities</li>
<li><strong>Bkg_Booking</strong> - Booking record (DateArrive,
DateDepart, TotalPrice, Status)</li>
<li><strong>Bkg_Availability</strong> - Daily availability calendar per
property</li>
<li><strong>Bkg_User</strong> - Guest profile (separate from Identity
user)</li>
<li><strong>Bkg_Payment</strong> - Payment tracking</li>
<li><strong>Bkg_Review</strong> - Guest reviews/ratings</li>
</ul>
<h2 id="bookingengine-service">BookingEngine Service</h2>
<p>The <code>IBookingEngine</code> (in
<code>Features/Bookings/Services/</code>) handles all booking operations
with transaction safety:</p>
<ul>
<li><code>RequestBooking()</code> - Check availability for requested
dates</li>
<li><code>CreateBookingAsync()</code> - Create new booking with
availability updates</li>
<li><code>EditBookingAsync()</code> - Handle 7 edit scenarios (A-G) for
date/property changes</li>
<li><code>DeleteBookingAsync()</code> - Remove booking and restore
availability</li>
<li><code>IsAvailable()</code> - Check date range availability</li>
</ul>
<p><strong>Edit Scenarios (A-G):</strong></p>
<pre><code>                    A1----------D1
(a) A2----------D2   |           |     New dates entirely before current
(b)         A2----------D2       |     New arrival before, depart within
(c)      A2---------------------------D2   New spans over current
(d)                  | A2----D2  |     New entirely within current
(e)                  |      A2----------D2  New arrival within, depart after
(f)                  |           |   A2----------D2  New dates entirely after
(g)  P1 != P2  Property change - treat as delete + create</code></pre>
<h2 id="key-pages">Key Pages</h2>
<ul>
<li><strong>Availability.razor</strong> - Property availability
search</li>
<li><strong>Booking.razor</strong> - Booking workflow</li>
<li><strong>MyBookings.razor</strong> - User’s bookings view (uses
IBookingEngine)</li>
<li><strong>AllBookings.razor</strong> - Admin booking management (uses
IBookingEngine)</li>
<li><strong>ViewBkgCalendar.razor</strong> - Calendar-based booking
view</li>
<li><strong>ContactRegister.razor</strong> - Registration and contact
form (uses IBookingEngine)</li>
</ul>
<h2 id="services-pattern">Services Pattern</h2>
<h3 id="booking-engine-vsa">Booking Engine (VSA)</h3>
<p>Injected via DI:
<code>@inject IBookingEngine BookingEngine</code></p>
<p>Registered in Program.cs:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddScoped</span><span class="op">&lt;</span>IBookingEngine<span class="op">,</span> BookingEngine<span class="op">&gt;();</span></span></code></pre></div>
<h3 id="mediatr-commandsqueries">MediatR Commands/Queries</h3>
<div class="sourceCode" id="cb5"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Send a command</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> result <span class="op">=</span> await Mediator<span class="op">.</span><span class="fu">Send</span><span class="op">(</span><span class="kw">new</span> <span class="fu">CreateBookingCommand</span><span class="op">(...));</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Send a query</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> bookings <span class="op">=</span> await Mediator<span class="op">.</span><span class="fu">Send</span><span class="op">(</span><span class="kw">new</span> <span class="fu">GetUserBookingsQuery</span><span class="op">(</span>userId<span class="op">));</span></span></code></pre></div>
<h3 id="email-and-sms">Email and SMS</h3>
<p>Pluggable implementations configured in
<code>appsettings.json</code>: - Email: <code>IEmailService</code> →
MailKitEmailService, SmtpEmailService, TNZEmailService, MockEmailService
- SMS: <code>ISmsService</code> → SmsEveryoneService, SmsTNZService,
SmsMockService</p>
<h2 id="configuration">Configuration</h2>
<ul>
<li><code>appsettings.json</code> - Main config (connection strings,
email/SMS settings)</li>
<li><code>appsettings.Development.json</code> /
<code>appsettings.Production.json</code> - Environment overrides</li>
<li>Localization: en-NZ (New Zealand English)</li>
<li>Authentication: 5-day session expiration, 3-hour token lifespan</li>
</ul>
<h2 id="database">Database</h2>
<ul>
<li>Local dev: <code>RONSHPLAPTOP\SQLEXPRESS</code>, database
<code>db_ac1621_rvpark</code></li>
<li>Migrations managed via dotnet-ef tool</li>
<li>DbContext includes helper methods for booking/availability
queries</li>
</ul>
<h2 id="di-registration-program.cs">DI Registration (Program.cs)</h2>
<p>Key service registrations:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// MediatR with validation pipeline</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddMediatR</span><span class="op">(</span>cfg <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    cfg<span class="op">.</span><span class="fu">RegisterServicesFromAssembly</span><span class="op">(</span><span class="kw">typeof</span><span class="op">(</span>Program<span class="op">).</span><span class="fu">Assembly</span><span class="op">);</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    cfg<span class="op">.</span><span class="fu">AddBehavior</span><span class="op">(</span><span class="kw">typeof</span><span class="op">(</span>IPipelineBehavior<span class="op">&lt;,&gt;),</span> <span class="kw">typeof</span><span class="op">(</span>ValidationBehavior<span class="op">&lt;,&gt;));</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">// FluentValidation</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddValidatorsFromAssembly</span><span class="op">(</span><span class="kw">typeof</span><span class="op">(</span>Program<span class="op">).</span><span class="fu">Assembly</span><span class="op">);</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Booking Engine</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddScoped</span><span class="op">&lt;</span>IBookingEngine<span class="op">,</span> BookingEngine<span class="op">&gt;();</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Authentication Service</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddScoped</span><span class="op">&lt;</span>IAuthenticationService<span class="op">,</span> AuthenticationService<span class="op">&gt;();</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">// AutoMapper</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddAutoMapper</span><span class="op">(</span>cfg <span class="op">=&gt;</span> cfg<span class="op">.</span><span class="fu">AddMaps</span><span class="op">(</span><span class="kw">typeof</span><span class="op">(</span>Program<span class="op">).</span><span class="fu">Assembly</span><span class="op">));</span></span></code></pre></div>
<h2 id="vsa-conversion-status-report">VSA Conversion Status Report</h2>
<p>● VSA Conversion Status Report as at 06/02/2026 after a fair bit of
work converting core booking features to Vertical Slice Architecture
(VSA). This report summarizes the current state of the codebase,
highlighting what has been converted, what remains in legacy structure,
and recommendations for next steps.</p>
<p>### Summary</p>
<p>The project is partially converted to VSA. Core booking functionality
uses MediatR, but significant legacy code remains.</p>
<table style="width:6%;">
<colgroup>
<col style="width: 5%" />
</colgroup>
<thead>
<tr class="header">
<th>Features Folder (VSA Structure)
┌────────────────┬─────────────────────────────┬───────────────────────────────────────────────────────────────────────┬────────────┬──────┬─────────┬─────────────┐
│ Feature │ Commands │ Queries │ Validators │ DTOs │ Mapping │ Pages │
├────────────────┼─────────────────────────────┼───────────────────────────────────────────────────────────────────────┼────────────┼──────┼─────────┼─────────────┤
│ Authentication │ 3 (Login, Logout, Register) │ 1 (GetCurrentUser) │ 2
│ 2 │ - │ 2 + 7 Admin │
├────────────────┼─────────────────────────────┼───────────────────────────────────────────────────────────────────────┼────────────┼──────┼─────────┼─────────────┤
│ Bookings │ 3 (Create, Edit, Delete) │ 4 (GetById, GetUserBookings,
CheckAvailability, GetBkgUserByUsername) │ 3 │ 2 │ 1 │ 9 │
├────────────────┼─────────────────────────────┼───────────────────────────────────────────────────────────────────────┼────────────┼──────┼─────────┼─────────────┤
│ Properties │ 1 (UpdateProperty) │ 2 (GetAll, GetById) │ 1 │ 1 │ 1 │ 6
│
├────────────────┼─────────────────────────────┼───────────────────────────────────────────────────────────────────────┼────────────┼──────┼─────────┼─────────────┤
│ Admin │ - │ - │ - │ - │ - │ 3 │
└────────────────┴─────────────────────────────┴───────────────────────────────────────────────────────────────────────┴────────────┴──────┴─────────┴─────────────┘
Total in Features/: 46 .cs files, 36 .razor pages</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Legacy Code Remaining (NOT in VSA)</td>
</tr>
<tr class="even">
<td>Components/Pages/ (18 pages)</td>
</tr>
<tr class="odd">
<td>- Home.razor, About.razor, Error.razor, Auth.razor -
ContactUs.razor, Thingstoknow.razor, Thingstoknowdetail.razor -
TabComponents/ (11 maintenance pages): - DB_Maint.razor,
DBTblNavMenu.razor, DynamicCRUD.razor - AspNetRoles_Maint.razor,
AspNetUser_Maint.razor, AspNetUserRoles_Maint.razor -
Bkg_Bookings_Maint.razor, Bkg_User_Maint.razor, Bkg_Property_Maint.razor
- Bkg_Availability_Maint.razor, BkgUser_Bookings.razor</td>
</tr>
<tr class="even">
<td>Components/Account/ (40+ pages)</td>
</tr>
<tr class="odd">
<td>- All Identity scaffolded pages remain in legacy location - Login,
Register, ForgotPassword, 2FA, Manage/* etc.</td>
</tr>
<tr class="even">
<td>Data/ Folder (Legacy Services &amp; Models)</td>
</tr>
<tr class="odd">
<td>- Bkg_Engine.cs - Old booking engine (kept for reference) -
Bkg_UserService.cs - Should move to Features/Bookings/Services/ -
EmailSenderMailKit.cs, EmailSenderSystem.cs - Duplicates of
Services/Email/ - SmsService.cs, SmsModels.cs - Duplicates of
Services/SMS/ - MappingProfile.cs - Legacy mapping (should consolidate)
- Various helper classes that could move to Shared/</td>
</tr>
</tbody>
</table>
<p>MediatR Usage
┌───────────────────┬──────────────────────────────────────────────────────────┐
│ Status │ Description │
├───────────────────┼──────────────────────────────────────────────────────────┤
│ Implemented │ All booking CRUD operations use MediatR commands/queries
│
├───────────────────┼──────────────────────────────────────────────────────────┤
│ Implemented │ CheckAvailability query returns Result<bool> │
├───────────────────┼──────────────────────────────────────────────────────────┤
│ Implemented │ BookingEngine returns Result<T> with error messages │
├───────────────────┼──────────────────────────────────────────────────────────┤
│ Implemented │ ValidationBehavior pipeline in place │
├───────────────────┼──────────────────────────────────────────────────────────┤
│ Not Using MediatR │ TabComponent maintenance pages (direct DbContext)
│
├───────────────────┼──────────────────────────────────────────────────────────┤
│ Not Using MediatR │ Identity/Account pages │
└───────────────────┴──────────────────────────────────────────────────────────┘
— FluentValidation</p>
<p>6 validators exist: - LoginValidator, RegisterValidator -
CreateBookingValidator, EditBookingValidator, DeleteBookingValidator -
UpdatePropertyValidator</p>
<p>Missing validators for: Queries, other commands</p>
<table style="width:6%;">
<colgroup>
<col style="width: 5%" />
</colgroup>
<thead>
<tr class="header">
<th>AutoMapper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Recommended Next Steps</td>
</tr>
<tr class="even">
<td>1. High Priority: - Move Components/Pages/ContactUs.razor to
Features/ - Create MediatR queries for TabComponent pages or migrate
them 2. Medium Priority: - Consolidate duplicate services in Data/
folder - Move Bkg_UserService.cs to Features/Bookings/Services/ - Delete
Data/Bkg_Engine.cs (legacy, replaced by BookingEngine) 3. Lower
Priority: - Migrate Identity/Account pages to Features/Authentication/ -
Add missing validators for queries - Create DTOs for remaining entities
(Bkg_User, Bkg_Availability, etc.)</td>
</tr>
</tbody>
</table>
<p>### Completion Estimate as at 06/02/2026
┌────────────────────────┬─────────────────────────────────────────────┐
│ Area │ Status │
├────────────────────────┼─────────────────────────────────────────────┤
│ Bookings Feature │ ~90% complete │
├────────────────────────┼─────────────────────────────────────────────┤
│ Properties Feature │ ~70% complete │
├────────────────────────┼─────────────────────────────────────────────┤
│ Authentication Feature │ ~50% complete (Identity pages not migrated) │
├────────────────────────┼─────────────────────────────────────────────┤
│ Admin Feature │ ~30% complete │
├────────────────────────┼─────────────────────────────────────────────┤
│ Overall VSA Conversion │ ~55% │
└────────────────────────┴─────────────────────────────────────────────┘</p>
